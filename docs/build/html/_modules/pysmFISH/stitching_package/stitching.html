

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pysmFISH.stitching_package.stitching &mdash; pysmFISH 0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> pysmFISH
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome to pysmFISH!</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cluster/index.html">Cluster setup</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../API/index.html">API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline/index.html">Processing pipeline</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../license/index.html">License</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../citing/index.html">Author and citations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ind_tables/index.html">Indices and Tables</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pysmFISH</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pysmFISH.stitching_package.stitching</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pysmFISH.stitching_package.stitching</h1><div class="highlight"><pre>
<span></span>
<span class="sd">&quot;&quot;&quot;Find or apply coordinates to stitch an image</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">#import matplotlib.pyplot as plt</span>
<span class="c1">#plt_available = True</span>
<span class="n">plt_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">import</span> <span class="nn">sklearn.feature_extraction.image</span> <span class="k">as</span> <span class="nn">sklim</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">skimage.transform</span> <span class="k">as</span> <span class="nn">smtf</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Own imports</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">inout</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">pairwisesingle</span> <span class="k">as</span> <span class="n">ps</span>
<span class="kn">from</span> <span class="nn">.MicroscopeData</span> <span class="k">import</span> <span class="n">MicroscopeData</span>
<span class="kn">from</span> <span class="nn">.GlobalOptimization</span> <span class="k">import</span> <span class="n">GlobalOptimization</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tilejoining</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">utils</span>

<span class="c1"># Logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">#################### Initial stitching functions #######################</span>
<div class="viewcode-block" id="get_pairwise_input"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.get_pairwise_input">[docs]</a><span class="k">def</span> <span class="nf">get_pairwise_input</span><span class="p">(</span><span class="n">ImageProperties</span><span class="p">,</span><span class="n">folder</span><span class="p">,</span> <span class="n">tile_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span> <span class="o">=</span> <span class="s1">&#39;Nuclei&#39;</span><span class="p">,</span>
                        <span class="n">pre_proc_level</span> <span class="o">=</span> <span class="s1">&#39;FilteredData&#39;</span><span class="p">,</span>
                        <span class="n">est_overlap</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">y_flip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nr_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the information necessary to do the pairwise allignment</span>

<span class="sd">    Find the pairwise pars for an unknown stitching.</span>
<span class="sd">    Works best with a folder containing</span>
<span class="sd">    image with nuclei (DAPI staining)</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        String representing the path of the folder containing</span>
<span class="sd">        the tile file and the yaml metadata file. Needs a</span>
<span class="sd">        trailing slash (&#39;/&#39;).</span>
<span class="sd">    tile_file: pointer</span>
<span class="sd">        HDF5 file handle. Reference to the opened file containing the tiles.</span>
<span class="sd">    hyb_nr: int</span>
<span class="sd">        The number of the hybridization we are going to</span>
<span class="sd">        stitch. This will be used to navigate tile_file and find</span>
<span class="sd">        the correct tiles.</span>
<span class="sd">    gene: str</span>
<span class="sd">        The name of the gene we are going to stitch.</span>
<span class="sd">        This will be used to navigate tile_file and find the</span>
<span class="sd">        correct tiles. (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    pre_proc_level: str</span>
<span class="sd">        The name of the pre processing group of</span>
<span class="sd">        the tiles we are going to stitch.</span>
<span class="sd">        This will be used to navigate tile_file and find the</span>
<span class="sd">        correct tiles. (Default: &#39;Filtered&#39;)</span>
<span class="sd">    est_overlap: float</span>
<span class="sd">        The fraction of two neighbours that should</span>
<span class="sd">        overlap, this is used to estimate the shape of the</span>
<span class="sd">        tile set and then overwritten by the actual average</span>
<span class="sd">        overlap according to the microscope coordinates.</span>
<span class="sd">        (default: 0.1)</span>
<span class="sd">    y_flip: bool</span>
<span class="sd">        The y_flip variable is designed for the cases where the</span>
<span class="sd">        microscope sequence is inverted in the y-direction. When</span>
<span class="sd">        set to True the y-coordinates will also be inverted</span>
<span class="sd">        before determining the tile set. (Default: False)</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (Default: 2)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    tiles: list</span>
<span class="sd">        List of references to the the tiles in the hdf5 file tile_file.</span>
<span class="sd">    contig_tuples: list</span>
<span class="sd">        List of tuples. Each tuple is a tile pair.</span>
<span class="sd">        Tuples contain two tile indexes denoting these</span>
<span class="sd">        tiles are contingent to each other.</span>
<span class="sd">    nr_pixels: int</span>
<span class="sd">        Height and length of the tile in pixels, tile is assumed to be square.</span>
<span class="sd">    z_count: int</span>
<span class="sd">        The number of layers in one tile (size of the z-axis). Is 1 when nr_dim is not 3.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Contains coordinates of the tile corners as taken from the microscope.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting files from folder: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">folder</span><span class="p">))</span>

    <span class="c1"># Load the information from the metadata file.</span>
    <span class="n">ExperimentInfos</span><span class="p">,</span> <span class="n">ImageProperties</span><span class="p">,</span> <span class="n">HybridizationsInfos</span><span class="p">,</span> \
    <span class="n">Converted_Positions</span><span class="p">,</span> <span class="n">MicroscopeParameters</span> <span class="o">=</span> \
        <span class="n">utils</span><span class="o">.</span><span class="n">experimental_metadata_parser</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="c1"># Get coordinate data for this hybridization</span>
    <span class="n">coord_data</span> <span class="o">=</span> <span class="n">Converted_Positions</span><span class="p">[</span><span class="s1">&#39;Hybridization&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hyb_nr</span><span class="p">)]</span>

    <span class="c1"># Read the number of pixels, z-count and pixel size from the yaml</span>
    <span class="c1"># file.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nr_pixels</span>       <span class="o">=</span> <span class="n">ImageProperties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;the number of pixels in an image &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; rows.</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">nr_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">z_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z_count</span> <span class="o">=</span> <span class="n">ImageProperties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;zcount&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;the number of slices in the z-stack &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; zcount.</span><span class="se">\n</span><span class="s2">&quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">ImageProperties</span><span class="p">[</span><span class="s1">&#39;PixelSize&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;ImageProperties[&#39;PixelSize&#39;] not found in &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;experimental metadata file.</span><span class="se">\n</span><span class="s2">Please add the &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;size of a pixel in um in the experimental &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;--&gt; PixelSize.</span><span class="se">\n</span><span class="s2">KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span>
    <span class="c1"># Estimate the overlap in pixels with the overlap that the user</span>
    <span class="c1"># provided, default is 10%</span>
    <span class="n">est_x_tol</span> <span class="o">=</span> <span class="n">nr_pixels</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">est_overlap</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Estimating overlap at </span><span class="si">{}</span><span class="s2">%, that is </span><span class="si">{}</span><span class="s2"> pixels&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">est_overlap</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">est_x_tol</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Number of pixels: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nr_pixels</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Number of slices in z-stack: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z_count</span><span class="p">))</span>

    <span class="c1"># Organize the microscope data and determine tile set</span>
    <span class="n">micData</span> <span class="o">=</span> <span class="n">MicroscopeData</span><span class="p">(</span><span class="n">coord_data</span><span class="p">,</span> <span class="n">y_flip</span><span class="p">,</span> <span class="n">nr_dim</span><span class="p">)</span>
    <span class="n">micData</span><span class="o">.</span><span class="n">normalize_coords</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">)</span>
    <span class="n">micData</span><span class="o">.</span><span class="n">make_tile_set</span><span class="p">(</span><span class="n">est_x_tol</span><span class="p">,</span> <span class="n">nr_pixels</span> <span class="o">=</span> <span class="n">nr_pixels</span><span class="p">)</span>

    <span class="c1"># Make a list of image numbers, matching with the numbers in the</span>
    <span class="c1"># image files</span>
    <span class="n">flat_tile_set</span> <span class="o">=</span> <span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>

    <span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_nr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">flat_tile_set</span><span class="p">]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting references for: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_list</span><span class="p">))</span>

    <span class="c1"># Make a list of the image names</span>
    <span class="n">tiles</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">get_image_names</span><span class="p">(</span><span class="n">tile_file</span><span class="p">,</span> <span class="n">image_list</span> <span class="o">=</span> <span class="n">image_list</span><span class="p">,</span>
                                    <span class="n">hyb_nr</span> <span class="o">=</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span> <span class="o">=</span> <span class="n">gene</span><span class="p">,</span>
                                    <span class="n">pre_proc_level</span> <span class="o">=</span> <span class="n">pre_proc_level</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Size tiles: </span><span class="si">{}</span><span class="s2"> Number of pixels: </span><span class="si">{}</span><span class="s2"> z count: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">),</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">))</span>

    <span class="c1"># Produce an undirected graph of the tiles, tiles that are</span>
    <span class="c1"># neighbours to each other are connected in this graph.</span>
    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sklim</span><span class="o">.</span><span class="n">grid_to_graph</span><span class="p">(</span><span class="o">*</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span> <span class="n">C</span> <span class="p">)</span>
    <span class="c1"># Extract the neighbour pairs from the graph</span>
    <span class="n">contig_tuples</span> <span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">C</span> <span class="p">)</span> <span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Length contingency tuples: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Contingency tuples: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">),</span> <span class="n">contig_tuples</span><span class="p">))</span>

    <span class="c1"># Plotting tiles:</span>
    <span class="c1">#inout.display_tiles(tiles, micData.tile_set, fig_nr = 2, block = False)</span>
    <span class="c1">#plt.show(block = True)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">contig_tuples</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">,</span> <span class="n">micData</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_pairwise_alignments"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.get_pairwise_alignments">[docs]</a><span class="k">def</span> <span class="nf">get_pairwise_alignments</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">tile_file</span><span class="p">,</span> <span class="n">contig_tuples</span><span class="p">,</span>
                                        <span class="n">micData</span><span class="p">,</span> <span class="n">nr_peaks</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                                        <span class="n">nr_slices</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="n">nr_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the pairwise transition</span>

<span class="sd">    Calculates pairwise transition for each neighbouring pair of</span>
<span class="sd">    tiles. This functions is only used in the single core version of the</span>
<span class="sd">    code, not when using MPI.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    tiles: list</span>
<span class="sd">        List of references to the the tiles in the hdf5 file tile_file.</span>
<span class="sd">    tile_file: pointer</span>
<span class="sd">        HDF5 file handle. Reference to the opened file containing the tiles.</span>
<span class="sd">    contig_tuples: list</span>
<span class="sd">        List of tuples. Each tuple is a tile pair.</span>
<span class="sd">        Tuples contain two tile indexes denoting these</span>
<span class="sd">        tiles are contingent to each other.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Containing coordinates of</span>
<span class="sd">        the tile corners as taken from the microscope.</span>
<span class="sd">    nr_peaks: int</span>
<span class="sd">        Number of peaks to be extracted from the PCM (Default: 8)</span>
<span class="sd">    nr_slices: int </span>
<span class="sd">        Only applicable when running with 3D</span>
<span class="sd">        pictures and using &#39;compres pic&#39; method in</span>
<span class="sd">        pairwisesingle.py. Determines the number of slices</span>
<span class="sd">        that are compressed together (compression in the</span>
<span class="sd">        z-direction). If None, all the slices are compressed</span>
<span class="sd">         together. (Default: None)</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (default: 2)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    : dict</span>
<span class="sd">        Contains key &#39;P&#39; with a 1D numpy array</span>
<span class="sd">        containing pairwise alignment y and x coordinates</span>
<span class="sd">        (and z-coordinates when applicable) for each</span>
<span class="sd">        neighbouring pair of tiles, array will be</span>
<span class="sd">        2 * len(contig_typles) for 2D data</span>
<span class="sd">        or 3 * len(contig_typles) for 3D data.</span>
<span class="sd">        Also contains key &#39;covs&#39; with a 1D numpy array</span>
<span class="sd">        containing covariance for each pairwise alignment in</span>
<span class="sd">        &#39;P&#39;, &#39;covs&#39; will be len(contig_typles).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting pairwise alignments...&quot;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">),</span> <span class="n">nr_dim</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">covs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">)):</span>
        <span class="c1"># noinspection PyPep8Naming</span>
        <span class="n">P_single</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">contig_index</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">align_single_pair</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">tile_file</span><span class="p">,</span>
                                        <span class="n">contig_tuples</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
                                        <span class="n">micData</span><span class="p">,</span> <span class="n">nr_peaks</span><span class="p">,</span>
                                        <span class="n">nr_slices</span> <span class="o">=</span> <span class="n">nr_slices</span><span class="p">,</span>
                                        <span class="n">nr_dim</span> <span class="o">=</span> <span class="n">nr_dim</span><span class="p">)</span>
        <span class="n">P</span><span class="p">[</span><span class="n">contig_index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">P_single</span>
        <span class="n">covs</span><span class="p">[</span><span class="n">contig_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Raw P: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>
    <span class="c1">#Flatten P</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;flat P: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">P</span><span class="p">,</span> <span class="s1">&#39;covs&#39;</span><span class="p">:</span> <span class="n">covs</span><span class="p">}</span></div>

<span class="c1">############################# Apply ####################################</span>
<div class="viewcode-block" id="get_place_tile_input_apply"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.get_place_tile_input_apply">[docs]</a><span class="k">def</span> <span class="nf">get_place_tile_input_apply</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">tile_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span>
                                <span class="n">gene</span> <span class="o">=</span> <span class="s1">&#39;Nuclei&#39;</span><span class="p">,</span>
                                <span class="n">pre_proc_level</span> <span class="o">=</span> <span class="s1">&#39;Filtered&#39;</span><span class="p">,</span>
                                <span class="n">nr_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">check_pairwise</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the data needed to apply stitching to another gene</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        String representing the path of the folder containing</span>
<span class="sd">        the tile file, the stitching data file the yaml metadata</span>
<span class="sd">        file. Needs a trailing slash (&#39;/&#39;).</span>
<span class="sd">    tile_file: pointer</span>
<span class="sd">        HDF5 file handle. Reference to the opened file</span>
<span class="sd">        containing the tiles.</span>
<span class="sd">    hyb_nr: int</span>
<span class="sd">        The number of the hybridization we are going to</span>
<span class="sd">        stitch. This will be used to navigate tile_file and find</span>
<span class="sd">        the correct tiles.</span>
<span class="sd">    data_name: str</span>
<span class="sd">        Name of the file containing the pickled stitching data.</span>
<span class="sd">    gene: str</span>
<span class="sd">        The name of the gene we are going to stitch.</span>
<span class="sd">        This will be used to navigate tile_file and find the</span>
<span class="sd">        correct tiles. (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    pre_proc_level: str</span>
<span class="sd">        The name of the pre processing group of</span>
<span class="sd">        the tiles we are going to stitch.</span>
<span class="sd">        This will be used to navigate tile_file and find the</span>
<span class="sd">        correct tiles. (Default: &#39;Filtered&#39;)</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (Default: 2)</span>
<span class="sd">    check_pairwise: bool</span>
<span class="sd">        If True the contig_tuples array is assumed</span>
<span class="sd">        to be in the pickled data file and will be returned.</span>
<span class="sd">        (Default: False)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    joining: dict</span>
<span class="sd">        Taken from the stitching data file.</span>
<span class="sd">        Contains keys corner_list and final_image_shape.</span>
<span class="sd">        Corner_list is a list of list, each list is a pair</span>
<span class="sd">        of an image number (int) and it&#39;s coordinates (numpy</span>
<span class="sd">        array containing floats).</span>
<span class="sd">        Final_image_shape is a tuple of size 2 or 3</span>
<span class="sd">        depending on the numer of dimensions and contains</span>
<span class="sd">        ints.</span>
<span class="sd">    tiles: list</span>
<span class="sd">        List of references to the the tiles in the hdf5 file tile_file.</span>
<span class="sd">    nr_pixels: int</span>
<span class="sd">        Height and length of the tile in pixels, tile is assumed to be square.</span>
<span class="sd">    z_count: int</span>
<span class="sd">        The number of layers in one tile (size of</span>
<span class="sd">        the z-axis). Is 1 when nr_dim is not 3.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Taken from the pickled</span>
<span class="sd">        stitching data.</span>
<span class="sd">        Contains coordinates of the tile corners as taken</span>
<span class="sd">        from the microscope.</span>
<span class="sd">    contig_tuples: list</span>
<span class="sd">        Only returned if check_pairwise == True.</span>
<span class="sd">        list of tuples. Taken from the pickled</span>
<span class="sd">        stitching data. Each tuple is a tile pair.</span>
<span class="sd">        Tuples contain two tile indexes denoting these</span>
<span class="sd">        tiles are contingent to each other.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting data to apply stitching from file...&quot;</span><span class="p">)</span>

    <span class="c1"># Load image list and old joining data</span>
    <span class="n">stitching_coord_dict</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">load_stitching_coord</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">)</span>
    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="n">micData</span> <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;micData&#39;</span><span class="p">]</span>
    <span class="n">joining</span> <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;joining&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining object and image list loaded from file&quot;</span><span class="p">)</span>

    <span class="c1"># Make a list of image numbers</span>
    <span class="n">flat_tile_set</span> <span class="o">=</span> <span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_nr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">flat_tile_set</span><span class="p">]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tile set size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Placing folowing image references in tiles: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_list</span><span class="p">))</span>

    <span class="c1"># Make a list of the tile references</span>
    <span class="n">tiles</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">get_image_names</span><span class="p">(</span><span class="n">tile_file</span><span class="p">,</span> <span class="n">image_list</span> <span class="o">=</span> <span class="n">image_list</span><span class="p">,</span>
                                <span class="n">hyb_nr</span> <span class="o">=</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span> <span class="o">=</span> <span class="n">gene</span><span class="p">,</span> <span class="n">pre_proc_level</span> <span class="o">=</span> <span class="n">pre_proc_level</span><span class="p">)</span>

    <span class="c1"># Load the data from the metadata file</span>
    <span class="n">ExperimentInfos</span><span class="p">,</span> <span class="n">ImageProperties</span><span class="p">,</span> <span class="n">HybridizationsInfos</span><span class="p">,</span> \
    <span class="n">Converted_Positions</span><span class="p">,</span> <span class="n">MicroscopeParameters</span> <span class="o">=</span> \
        <span class="n">utils</span><span class="o">.</span><span class="n">experimental_metadata_parser</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Read the number of pixels and z-count from the yaml</span>
    <span class="c1"># file.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nr_pixels</span> <span class="o">=</span> <span class="n">ImageProperties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;the number of pixels in an image &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; rows.</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">nr_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">z_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z_count</span> <span class="o">=</span> <span class="n">ImageProperties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;zcount&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;the number of slices in the z-stack &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; zcount.</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Size tiles: </span><span class="si">{}</span><span class="s2"> Number of pixels: </span><span class="si">{}</span><span class="s2"> z count: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">tiles</span><span class="p">),</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">))</span>

    <span class="c1"># Check pairwise overlap in signal</span>
    <span class="k">if</span> <span class="n">check_pairwise</span><span class="p">:</span>
        <span class="n">contig_tuples</span>   <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;contig_tuples&#39;</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Length contingency tuples: </span><span class="si">{}</span><span class="s2"> Contingency tuples: </span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">),</span> <span class="n">contig_tuples</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">joining</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">,</span> <span class="n">micData</span><span class="p">,</span>
                                            <span class="n">contig_tuples</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">joining</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">,</span> <span class="n">micData</span><span class="p">)</span></div>


<span class="c1">############################# Refine ###################################</span>
<div class="viewcode-block" id="get_refine_pairwise_input"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.get_refine_pairwise_input">[docs]</a><span class="k">def</span> <span class="nf">get_refine_pairwise_input</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">tile_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span>
                                <span class="n">gene</span> <span class="o">=</span> <span class="s1">&#39;Nuclei&#39;</span><span class="p">,</span> <span class="n">pre_proc_level</span> <span class="o">=</span> <span class="s1">&#39;Filtered&#39;</span><span class="p">,</span>
                                <span class="n">nr_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the data needed to refine stitching with another gene</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        String representing the path of the folder containing</span>
<span class="sd">        the tile file, the stitching data file the yaml metadata</span>
<span class="sd">        file. Needs a trailing slash (&#39;/&#39;).</span>
<span class="sd">    tile_file: pointer</span>
<span class="sd">        HDF5 file handle. Reference to the opened file</span>
<span class="sd">        containing the tiles.</span>
<span class="sd">    hyb_nr: int</span>
<span class="sd">        The number of the hybridization we are going to</span>
<span class="sd">        stitch. This will be used to navigate tile_file and find</span>
<span class="sd">        the correct tiles.</span>
<span class="sd">    data_name: str</span>
<span class="sd">        Name of the file containing the pickled stitching data.</span>
<span class="sd">    gene: str</span>
<span class="sd">        The name of the gene we are going to stitch.</span>
<span class="sd">        This will be used to navigate tile_file and find the</span>
<span class="sd">        correct tiles. (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    pre_proc_level: str</span>
<span class="sd">        The name of the pre processing group of</span>
<span class="sd">        the tiles we are going to stitch.</span>
<span class="sd">        This will be used to navigate tile_file and find the</span>
<span class="sd">        correct tiles. (Default: &#39;Filtered&#39;)</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (Default: 2)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    tiles: list</span>
<span class="sd">        List of references to the the tiles in the hdf5 file tile_file.</span>
<span class="sd">    contig_tuples: list</span>
<span class="sd">        List of tuples. Each tuple is a tile pair.</span>
<span class="sd">        Tuples contain two tile indexes denoting these</span>
<span class="sd">        tiles are contingent to each other.</span>
<span class="sd">    nr_pixels: int</span>
<span class="sd">        Height and length of the tile in pixels, tile</span>
<span class="sd">        is assumed to be square.</span>
<span class="sd">    z_count: int</span>
<span class="sd">        The number of layers in one tile (size of the z-axis). Is 1 when nr_dim is not 3.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Contains coordinates of</span>
<span class="sd">        the tile corners as taken from the microscope.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Aplying stitching from file&quot;</span><span class="p">)</span>

    <span class="c1"># Load image list and old joining data</span>
    <span class="n">stitching_coord_dict</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">load_stitching_coord</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">)</span>
    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="n">micData</span> <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;micData&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining object and image list loaded from file&quot;</span><span class="p">)</span>

    <span class="n">flat_tile_set</span> <span class="o">=</span> <span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_nr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">flat_tile_set</span><span class="p">]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tile set size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading images: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_list</span><span class="p">))</span>

    <span class="c1"># Make a list of the image names</span>
    <span class="n">tiles</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">get_image_names</span><span class="p">(</span><span class="n">tile_file</span><span class="p">,</span> <span class="n">image_list</span> <span class="o">=</span> <span class="n">image_list</span><span class="p">,</span>
                                <span class="n">hyb_nr</span> <span class="o">=</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span> <span class="o">=</span> <span class="n">gene</span><span class="p">,</span> <span class="n">pre_proc_level</span> <span class="o">=</span> <span class="n">pre_proc_level</span><span class="p">)</span>

    <span class="n">contig_tuples</span>   <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;contig_tuples&#39;</span><span class="p">]</span>
    <span class="n">alignment_old</span>   <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;alignment&#39;</span><span class="p">][</span><span class="s1">&#39;P&#39;</span><span class="p">]</span>

    <span class="c1"># Load the data from the metadata file</span>
    <span class="n">ExperimentInfos</span><span class="p">,</span> <span class="n">ImageProperties</span><span class="p">,</span> <span class="n">HybridizationsInfos</span><span class="p">,</span> \
    <span class="n">Converted_Positions</span><span class="p">,</span> <span class="n">MicroscopeParameters</span> <span class="o">=</span> \
        <span class="n">utils</span><span class="o">.</span><span class="n">experimental_metadata_parser</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="c1"># Read the number of pixels and z-count from the yaml</span>
    <span class="c1"># file.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nr_pixels</span> <span class="o">=</span> <span class="n">ImageProperties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;the number of pixels in an image &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; rows.</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">nr_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">z_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z_count</span> <span class="o">=</span> <span class="n">ImageProperties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;zcount&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;the number of slices in the z-stack &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; zcount.</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span>


    <span class="c1"># Recalculate C</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">sklim</span><span class="o">.</span><span class="n">grid_to_graph</span><span class="p">(</span><span class="o">*</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span> <span class="n">C</span> <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">contig_tuples</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">,</span> <span class="n">micData</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">alignment_old</span><span class="p">)</span></div>


<div class="viewcode-block" id="refine_pairwise_alignments"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.refine_pairwise_alignments">[docs]</a><span class="k">def</span> <span class="nf">refine_pairwise_alignments</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">tile_file</span><span class="p">,</span> <span class="n">contig_tuples</span><span class="p">,</span> <span class="n">alignment_old</span><span class="p">,</span>
                                        <span class="n">micData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nr_peaks</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
                                        <span class="n">nr_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate the pairwise transition</span>

<span class="sd">    Calculates pairwise transition for each neighbouring pair of</span>
<span class="sd">    tiles.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    tiles: np.array</span>
<span class="sd">        Array of tiles, a tile should be a 2d np.array</span>
<span class="sd">        representing a picture</span>
<span class="sd">    contig_tuples: list</span>
<span class="sd">        List of tuples denoting which tiles are contingent to each other.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object containing coordinates (default None)</span>
<span class="sd">    nr_peaks: int</span>
<span class="sd">        nr of peaks to be extracted from the PCM (default 8)</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (default: 2)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    : dict</span>
<span class="sd">        Contains key &#39;P&#39; with a 1D numpy array</span>
<span class="sd">        containing pairwise alignment y and x coordinates</span>
<span class="sd">        (and z-coordinates when applicable) for each</span>
<span class="sd">        neighbouring pair of tiles, array will be</span>
<span class="sd">        2 * len(contig_typles) for 2D data</span>
<span class="sd">        or 3 * len(contig_typles) for 3D data.</span>
<span class="sd">        Also contains key &#39;covs&#39; with a 1D numpy array</span>
<span class="sd">        containing covariance for each pairwise alignment in</span>
<span class="sd">        &#39;P&#39;, &#39;covs&#39; will be len(contig_typles).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make a new P and cov list for the refine pairwise alignments</span>
    <span class="n">P_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">),</span> <span class="n">nr_dim</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">covs_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">)):</span>
        <span class="n">P_single</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">contig_index</span>  <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">refine_single_pair</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span>
                                        <span class="n">tile_file</span><span class="p">,</span>
                                        <span class="n">contig_tuples</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">micData</span><span class="p">,</span>
                                        <span class="n">alignment_old</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span> <span class="n">nr_peaks</span><span class="p">,</span>
                                        <span class="n">nr_dim</span> <span class="o">=</span> <span class="n">nr_dim</span><span class="p">)</span>
        <span class="n">P_ref</span><span class="p">[</span><span class="n">contig_index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">P_single</span>
        <span class="n">covs_ref</span><span class="p">[</span><span class="n">contig_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Raw P: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P_ref</span><span class="p">))</span>
    <span class="c1"># Flatten P</span>
    <span class="n">P_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">P_ref</span><span class="p">)</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;flat P: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P_ref</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">P_ref</span><span class="p">,</span> <span class="s1">&#39;covs&#39;</span><span class="p">:</span> <span class="n">covs_ref</span><span class="p">}</span></div>


<span class="c1">######################### General functions ############################</span>
<div class="viewcode-block" id="get_place_tile_input"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.get_place_tile_input">[docs]</a><span class="k">def</span> <span class="nf">get_place_tile_input</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">contig_tuples</span><span class="p">,</span>
                            <span class="n">micData</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span>
                            <span class="n">data_name</span><span class="p">,</span> <span class="n">nr_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">save_alignment</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do the global alignment and get the shifted corner coordinates.</span>

<span class="sd">    Calculates a shift in global coordinates for each tile (global</span>
<span class="sd">    alignment) and then applies these shifts to the  corner coordinates</span>
<span class="sd">    of each tile and returns and saves these shifted corner coordinates.</span>

<span class="sd">    This function produces a file with stitching data in folder</span>
<span class="sd">    called data_name, this file includes the corner coordinates which</span>
<span class="sd">    can be used to apply the stitching to another gene.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        String representing the path of the folder containing</span>
<span class="sd">        the tile file and the yaml metadata file. Needs a</span>
<span class="sd">        trailing slash (&#39;/&#39;).</span>
<span class="sd">    tiles: list</span>
<span class="sd">        List of strings. List of references to the the</span>
<span class="sd">        tiles in the hdf5 file tile_file.</span>
<span class="sd">    contig_tuples: list</span>
<span class="sd">        List of tuples. Each tuple is a tile pair.</span>
<span class="sd">        Tuples contain two tile indexes denoting these</span>
<span class="sd">        tiles are contingent to each other.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Contains coordinates of</span>
<span class="sd">        the tile corners as taken from the microscope.</span>
<span class="sd">    nr_pixels: int</span>
<span class="sd">        Height and length of the tile in pixels, tile is assumed to be square.</span>
<span class="sd">    z_count: int</span>
<span class="sd">        The number of layers in one tile (size of the z-axis). Is 1 when nr_dim is not 3.</span>
<span class="sd">    alignment: dict</span>
<span class="sd">        Contains key &#39;P&#39; with a 1D numpy array</span>
<span class="sd">        containing pairwise alignment y and x coordinates</span>
<span class="sd">        (and z-coordinates when applicable) for each</span>
<span class="sd">        neighbouring pair of tiles, array will be</span>
<span class="sd">        2 * len(contig_typles) for 2D data</span>
<span class="sd">        or 3 * len(contig_typles) for 3D data.</span>
<span class="sd">        Also contains key &#39;covs&#39; with a 1D numpy array</span>
<span class="sd">        containing covariance for each pairwise alignment in</span>
<span class="sd">        &#39;P&#39;, &#39;covs&#39; will be len(contig_typles).</span>
<span class="sd">    data_name: str</span>
<span class="sd">        Name of the file containing the pickled stitching data.</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (default: 2)</span>
<span class="sd">    save_alignment: bool</span>
<span class="sd">        When False only the stitching</span>
<span class="sd">        coordinates and microscope data will be saved. When</span>
<span class="sd">        True also the contigency tuples and pairwise</span>
<span class="sd">        alignment will be saved (this is necessary if we</span>
<span class="sd">        want to refine the stitching later). (Default: True)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    joining: dict</span>
<span class="sd">        Contains keys corner_list and</span>
<span class="sd">        final_image_shape.</span>
<span class="sd">        Corner_list is a list of list, each list is a pair</span>
<span class="sd">        of a tile index (int) and it&#39;s tile&#39;s shifted</span>
<span class="sd">        coordinates in the final image (numpy array</span>
<span class="sd">        containing floats).</span>
<span class="sd">        Final_image_shape is a tuple of size 2 or 3</span>
<span class="sd">        depending on the numer of dimensions and contains</span>
<span class="sd">        ints.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Perform global optimization</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing global optimization&quot;</span><span class="p">)</span>
    <span class="n">optimization</span> <span class="o">=</span> <span class="n">GlobalOptimization</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting optimization, micData&quot;</span><span class="p">)</span>
    <span class="n">optimization</span><span class="o">.</span><span class="n">performOptimization</span><span class="p">(</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="p">,</span> <span class="n">contig_tuples</span><span class="p">,</span>
                                <span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span> <span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;covs&#39;</span><span class="p">],</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">tiles</span><span class="p">),</span> <span class="n">nr_dim</span><span class="p">)</span>


    <span class="c1"># Stitch everything back together</span>
    <span class="c1"># Determine global corners</span>
    <span class="n">joining</span> <span class="o">=</span> <span class="n">tilejoining</span><span class="o">.</span><span class="n">calc_corners_coord</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span>
                <span class="n">optimization</span><span class="o">.</span><span class="n">global_trans</span><span class="p">,</span> <span class="n">micData</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">)</span>

    <span class="c1"># Save the data to do the stitching in &quot;data_name&quot;:</span>
    <span class="k">if</span> <span class="n">joining</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">save_alignment</span><span class="p">:</span>
            <span class="n">inout</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span>
                               <span class="n">joining</span> <span class="o">=</span> <span class="n">joining</span><span class="p">,</span>
                               <span class="n">contig_tuples</span> <span class="o">=</span> <span class="n">contig_tuples</span><span class="p">,</span>
                               <span class="n">alignment</span> <span class="o">=</span> <span class="n">alignment</span><span class="p">,</span>
                               <span class="n">micData</span> <span class="o">=</span> <span class="n">micData</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inout</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">,</span>
                                <span class="n">micData</span> <span class="o">=</span> <span class="n">micData</span><span class="p">,</span>
                                <span class="n">joining</span> <span class="o">=</span> <span class="n">joining</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No results found to save: joining is empty&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">joining</span></div>

<div class="viewcode-block" id="assess_performance"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.assess_performance">[docs]</a><span class="k">def</span> <span class="nf">assess_performance</span><span class="p">(</span><span class="n">micData</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">joining</span><span class="p">,</span>
                        <span class="n">cov_signal</span><span class="p">,</span> <span class="n">xcov_list</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span>
                        <span class="n">use_IJ_corners</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assess the performance of the stitching</span>

<span class="sd">    This functions writes its the result to a file in &quot;folder&quot;.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Contains coordinates of</span>
<span class="sd">        the tile corners as taken from the microscope</span>
<span class="sd">        and contains the tile set.</span>
<span class="sd">    alignment: dict</span>
<span class="sd">        Contains key &#39;P&#39; with a 1D numpy array</span>
<span class="sd">        containing pairwise alignment y and x coordinates</span>
<span class="sd">        (and z-coordinates when applicable) for each</span>
<span class="sd">        neighbouring pair of tiles, array will be</span>
<span class="sd">        2 * len(contig_typles) for 2D data</span>
<span class="sd">        or 3 * len(contig_typles) for 3D data.</span>
<span class="sd">        Also contains key &#39;covs&#39; with a 1D numpy array</span>
<span class="sd">        containing covariance for each pairwise alignment in</span>
<span class="sd">        &#39;P&#39;, &#39;covs&#39; will be len(contig_typles).</span>
<span class="sd">    joining: dict</span>
<span class="sd">        Contains keys corner_list and</span>
<span class="sd">        final_image_shape.</span>
<span class="sd">        Corner_list is a list of list, each list is a pair</span>
<span class="sd">        of a tile index (int) and it&#39;s tile&#39;s shifted</span>
<span class="sd">        coordinates in the final image (numpy array</span>
<span class="sd">        containing floats).</span>
<span class="sd">        Final_image_shape is a tuple of size 2 or 3</span>
<span class="sd">        depending on the numer of dimensions and contains</span>
<span class="sd">        ints.</span>
<span class="sd">    cov_signal: np.array</span>
<span class="sd">        The covariance of each neighbouring</span>
<span class="sd">        tile pair in the part of the tiles that overlap in</span>
<span class="sd">        the final stitched signal image.</span>
<span class="sd">    xcov_list: list</span>
<span class="sd">        List of cross covariance of the</span>
<span class="sd">        overlap of the tiles in the final stitched image.</span>
<span class="sd">        As returned by tilejoining.assess_overlap.</span>
<span class="sd">    folder: str</span>
<span class="sd">        String representing a path. The folder where the</span>
<span class="sd">        performance report should be saved. Needs a</span>
<span class="sd">        trailing slash (&#39;/&#39;).</span>
<span class="sd">    use_IJ_corners: bool</span>
<span class="sd">        If True compare our corners to Image J</span>
<span class="sd">        found in a file in folder, the file name should</span>
<span class="sd">        contain: TileConfiguration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">################################Gather data#########################</span>
    <span class="n">report_string</span>   <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_IJ_corners</span><span class="p">:</span>
        <span class="n">compare_corners</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">read_IJ_corners</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="c1"># Make a list of image numbers, matching with the numbers in the</span>
        <span class="c1"># image files</span>
        <span class="n">flat_tile_set</span> <span class="o">=</span> <span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>
        <span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_nr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                      <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">flat_tile_set</span><span class="p">]</span>
        <span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compare our corners to the corner the ImageJ plugin found</span>
        <span class="c1"># Select the tiles we actually used:</span>
        <span class="n">compare_corners_new</span> <span class="o">=</span> <span class="p">[[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])]</span>
                                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">compare_corners</span>
                                <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">image_list</span><span class="p">]</span>
        <span class="c1"># Replace the indexes with numbering of the images:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;My corners </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joining</span><span class="p">[</span><span class="s1">&#39;corner_list&#39;</span><span class="p">]))</span>
        <span class="n">my_corners_new</span> <span class="o">=</span> <span class="p">[[</span><span class="n">image_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">joining</span><span class="p">[</span><span class="s1">&#39;corner_list&#39;</span><span class="p">])]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;My corners new </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_corners_new</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Compare corners new </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compare_corners_new</span><span class="p">))</span>
        <span class="c1"># Normalize, to make the first one the origin and compare</span>
        <span class="n">compare_origin</span>  <span class="o">=</span> <span class="n">compare_corners_new</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">my_origin</span>       <span class="o">=</span> <span class="n">my_corners_new</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;origins: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compare_origin</span><span class="p">,</span> <span class="n">my_origin</span><span class="p">))</span>

        <span class="n">cum_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">my_corners_new</span><span class="p">)):</span>
            <span class="n">my_cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">my_corners_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">my_origin</span><span class="p">)</span>
            <span class="n">compare_cur</span> <span class="o">=</span> <span class="p">(</span><span class="n">compare_corners_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">compare_origin</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">my_cur</span> <span class="o">-</span> <span class="n">compare_cur</span><span class="p">)</span>
            <span class="n">cum_diff</span> <span class="o">+=</span> <span class="n">diff</span>
            <span class="n">report_string</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;My tile: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, compare tile: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">; difference: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">my_corners_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">my_cur</span><span class="p">,</span>
                                        <span class="n">compare_corners_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">compare_cur</span><span class="p">,</span>
                                        <span class="n">diff</span><span class="p">))</span>
        <span class="n">report_string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cum_diff</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">my_corners_new</span><span class="p">))</span>

    <span class="c1"># Calculate average cross covariances of the overlaps in the final image:</span>
    <span class="k">if</span> <span class="n">xcov_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">av_xcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xcov_list</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No cross covariance data available&#39;</span><span class="p">)</span>
        <span class="n">av_xcov</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">report_string</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average cross covariance of final overlap: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">av_xcov</span><span class="p">)</span>
    <span class="n">report_string</span> <span class="o">+=</span> <span class="s2">&quot;Cross covariance list of final overlap: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xcov_list</span><span class="p">)</span>
    <span class="c1">#logger.debug(report_string)</span>

    <span class="c1">###################### Save the performance data ###################</span>
    <span class="n">perf_path</span> <span class="o">=</span> <span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;performance/&#39;</span>
    <span class="c1"># To print the logging to a file</span>
    <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">perf_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">perf_path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">perf_path</span><span class="p">,</span><span class="mo">0o777</span><span class="p">)</span>

    <span class="n">dateTag</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%y%m</span><span class="si">%d</span><span class="s2">_%H_%M_%S&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">perf_path</span> <span class="o">+</span> <span class="n">dateTag</span> <span class="o">+</span> <span class="s1">&#39;-performance&#39;</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">micData</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If available print the alignment results:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Tile set: </span><span class="se">\n</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Tile numbers: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="p">,</span> <span class="n">micData</span><span class="o">.</span><span class="n">tile_nr</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">alignment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If available print the alignment results:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;Pairwise Alignment: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Covariances: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;Average covariance: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">],</span> <span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;covs&#39;</span><span class="p">],</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">alignment</span><span class="p">[</span><span class="s1">&#39;covs&#39;</span><span class="p">])))</span>
        <span class="k">if</span> <span class="n">joining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;Corners after alignment: </span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">joining</span><span class="p">[</span><span class="s1">&#39;corner_list&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">cov_signal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Average pairwise covariance of the signal: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="s2">&quot;Pairwise covariance of the signal:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cov_signal</span><span class="p">),</span> <span class="n">cov_signal</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1">############################# Visualization ############################</span>
<div class="viewcode-block" id="save_as_tiff"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.save_as_tiff">[docs]</a><span class="k">def</span> <span class="nf">save_as_tiff</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">location_image</span><span class="p">,</span>
                    <span class="n">pre_proc_level</span> <span class="o">=</span> <span class="s1">&#39;StitchedImage&#39;</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Save the results as a tiff image for visual inspection.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    data_file: pointer</span>
<span class="sd">        HDF5 file handle. HDF5 file containing the final image.</span>
<span class="sd">    gene: str</span>
<span class="sd">        The name of the gene we stitched.</span>
<span class="sd">        This will be used to navigate data_file and find the</span>
<span class="sd">        correct final picture.</span>
<span class="sd">    hyb_nr: int</span>
<span class="sd">        The number of the hybridization we have</span>
<span class="sd">        stitched.This will be used to navigate data_file and</span>
<span class="sd">        find the correct final picture.</span>
<span class="sd">    location_image: str</span>
<span class="sd">        Full path to the file where the tiff file</span>
<span class="sd">        will be saved (extension not necessary).</span>
<span class="sd">    pre_proc_level: str</span>
<span class="sd">        The name of the pre processing group of</span>
<span class="sd">        the tiles we are going to stitch. Normally this will</span>
<span class="sd">        be &#39;StitchedImage&#39;, but when the final image is</span>
<span class="sd">        found in another datagroup it may be changed.</span>
<span class="sd">        This will be used to navigate data_file and find the</span>
<span class="sd">        correct final image. (Default: &#39;StitchedImage&#39;)</span>
<span class="sd">    mode: str</span>
<span class="sd">        Mode determines what color, quality and</span>
<span class="sd">        how many images are saved.</span>
<span class="sd">        Possible values for mode: save_ubyte, save_float,</span>
<span class="sd">        save_rgb. If another or no value is given the image</span>
<span class="sd">        is saved as is and a as a low quality copy</span>
<span class="sd">        (pixel depth 8 bits) (Default: &#39;both&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Save the results:</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;save_ubyte&#39;</span><span class="p">:</span>
        <span class="n">inout</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">pre_proc_level</span><span class="p">,</span>  <span class="s1">&#39;final_image_ubyte&#39;</span><span class="p">,</span> <span class="n">location_image</span> <span class="o">+</span> <span class="s1">&#39;_byte&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;save_float&#39;</span><span class="p">:</span>
        <span class="n">inout</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">pre_proc_level</span><span class="p">,</span> <span class="s1">&#39;final_image&#39;</span><span class="p">,</span> <span class="n">location_image</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;save_rgb&#39;</span><span class="p">:</span>
        <span class="n">inout</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">pre_proc_level</span><span class="p">,</span> <span class="s1">&#39;final_image_rgb&#39;</span><span class="p">,</span> <span class="n">location_image</span> <span class="o">+</span> <span class="s1">&#39;_rgb&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inout</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">pre_proc_level</span><span class="p">,</span> <span class="s1">&#39;final_image_ubyte&#39;</span><span class="p">,</span> <span class="n">location_image</span> <span class="o">+</span> <span class="s1">&#39;_byte&#39;</span><span class="p">)</span>
        <span class="n">inout</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">data_file</span><span class="p">,</span> <span class="n">hyb_nr</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">pre_proc_level</span><span class="p">,</span> <span class="s1">&#39;final_image&#39;</span><span class="p">,</span> <span class="n">location_image</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_final_image"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.plot_final_image">[docs]</a><span class="k">def</span> <span class="nf">plot_final_image</span><span class="p">(</span><span class="n">im_file_name</span><span class="p">,</span> <span class="n">joining</span><span class="p">,</span>  <span class="n">hyb_nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="n">gene</span> <span class="o">=</span> <span class="s1">&#39;Nuclei&#39;</span><span class="p">,</span> <span class="n">fig_name</span> <span class="o">=</span> <span class="s2">&quot;final image&quot;</span><span class="p">,</span>
                     <span class="n">shrink_image</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">block</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Displays the high quality final image in a plot window.</span>

<span class="sd">    Takes a lot of working memory for full sized images.</span>
<span class="sd">    When plt_available is false this function does nothing and returns</span>
<span class="sd">    None.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    im_file_name: str</span>
<span class="sd">        Filename of the hdf5 file, containing the final image.</span>
<span class="sd">    fig_name: str</span>
<span class="sd">        Name of the plotting window (default: &quot;final image&quot;).</span>
<span class="sd">    shrink_image: bool</span>
<span class="sd">        Turn on shrink_image to reduce display quality and memory usage. (Default: False)</span>
<span class="sd">    block: bool</span>
<span class="sd">        Plot blocks the running program untill</span>
<span class="sd">        the plotting window is closed if true. Turn off</span>
<span class="sd">        block to make the code continue untill the next call</span>
<span class="sd">        of  plt.show(block=True) before displaying the</span>
<span class="sd">        image. (default: True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">plt_available</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im_file_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Load the image from file</span>
            <span class="n">im_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_file_name</span> <span class="o">+</span> <span class="s1">&#39;_Hybridization&#39;</span> <span class="o">+</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">hyb_nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.sf.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">for_display</span> <span class="o">=</span> <span class="n">im_file</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Load the image from file</span>
            <span class="n">for_display</span> <span class="o">=</span> <span class="n">im_file_name</span><span class="p">[</span><span class="n">gene</span><span class="p">]</span> \
                                    <span class="p">[</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">][</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span>
        <span class="c1"># Shrink the image if necessary</span>
        <span class="k">if</span> <span class="n">shrink_image</span><span class="p">:</span>

            <span class="n">display_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">joining</span><span class="p">[</span><span class="s1">&#39;final_image_shape&#39;</span><span class="p">],</span>
                                            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;display size pixels: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">display_size</span><span class="p">))</span>
            <span class="n">for_display</span> <span class="o">=</span> <span class="n">smtf</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">for_display</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">display_size</span><span class="p">))</span>
        <span class="c1"># Plot the image</span>
        <span class="k">if</span> <span class="n">for_display</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">inout</span><span class="o">.</span><span class="n">plot_3D</span><span class="p">(</span><span class="n">for_display</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">for_display</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Load the image from file</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">im_file_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Load the image from file</span>
            <span class="n">im_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_file_name</span> <span class="o">+</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">for_display</span> <span class="o">=</span> <span class="n">im_file</span><span class="p">[</span><span class="s1">&#39;temp_mask&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">for_display</span> <span class="o">=</span> <span class="n">im_file_name</span><span class="p">[</span><span class="s1">&#39;Hybridization&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hyb_nr</span><span class="p">)][</span><span class="n">gene</span><span class="p">]</span> \
                        <span class="p">[</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">][</span><span class="s1">&#39;temp_mask&#39;</span><span class="p">]</span>
        <span class="c1"># Shrink the image if necessary</span>
        <span class="k">if</span> <span class="n">shrink_image</span><span class="p">:</span>
            <span class="n">display_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">joining</span><span class="o">.</span><span class="n">final_image_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;display size pixels: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">display_size</span><span class="p">))</span>
            <span class="n">for_display</span> <span class="o">=</span> <span class="n">smtf</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">for_display</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">display_size</span><span class="p">))</span>
        <span class="c1"># Plot the image</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig_name</span> <span class="o">+</span> <span class="s1">&#39; mask&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">for_display</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="n">block</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="get_pairwise_input_npy"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.get_pairwise_input_npy">[docs]</a><span class="k">def</span> <span class="nf">get_pairwise_input_npy</span><span class="p">(</span><span class="n">image_properties</span><span class="p">,</span><span class="n">converted_positions</span><span class="p">,</span> <span class="n">hybridization</span><span class="p">,</span>
                        <span class="n">est_overlap</span><span class="p">,</span> <span class="n">y_flip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nr_dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the information necessary to do the pairwise allignment</span>
<span class="sd">    Modified version of the get_pairwise_input functions that work on .npy </span>
<span class="sd">    files and not on hdf5</span>

<span class="sd">    Find the pairwise pairs for an unknown stitching.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>
<span class="sd">    </span>
<span class="sd">    image_properties: dict </span>
<span class="sd">        Dictionary with the image details parsed from the Experimental_metadata.yaml file</span>
<span class="sd">    converted_positions: dict</span>
<span class="sd">        Dictionary  with the coords of the images for all hybridization</span>
<span class="sd">        The coords are a list of floats</span>
<span class="sd">    hybridization: str </span>
<span class="sd">        Hybridization that will be processed (Ex. Hybridization2)</span>
<span class="sd">    est_overlap: float</span>
<span class="sd">        The fraction of two neighbours that should</span>
<span class="sd">        overlap, this is used to estimate the shape of the</span>
<span class="sd">        tile set and then overwritten by the actual average</span>
<span class="sd">        overlap according to the microscope coordinates.</span>
<span class="sd">        (default: 0.1)</span>
<span class="sd">    y_flip: bool</span>
<span class="sd">        The y_flip variable is designed for the cases where the</span>
<span class="sd">        microscope sequence is inverted in the y-direction. When</span>
<span class="sd">        set to True the y-coordinates will also be inverted</span>
<span class="sd">        before determining the tile set. (Default: False)</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (Default: 2)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    tiles: np.array</span>
<span class="sd">        Array of int with the tiles number. -1 indicate an empty tile</span>
<span class="sd">    contig_tuples: list</span>
<span class="sd">        List of tuples. Each tuple is a tile pair.</span>
<span class="sd">        Tuples contain two tile indexes denoting these</span>
<span class="sd">        tiles are contingent to each other.</span>
<span class="sd">    nr_pixels: int</span>
<span class="sd">        Height and length of the tile in pixels, tile is assumed to be square.</span>
<span class="sd">    z_count: int</span>
<span class="sd">        The number of layers in one tile (size of</span>
<span class="sd">        the z-axis). Is 1 when nr_dim is not 3.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Contains coordinates of</span>
<span class="sd">        the tile corners as taken from the microscope.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1"># Get coordinate data for this hybridization</span>
    <span class="n">coord_data</span> <span class="o">=</span> <span class="n">converted_positions</span><span class="p">[</span><span class="n">hybridization</span><span class="p">]</span>

    <span class="c1"># Read the number of pixels, z-count and pixel size from the yaml</span>
    <span class="c1"># file.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nr_pixels</span>       <span class="o">=</span> <span class="n">image_properties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;the number of pixels in an image &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; rows.</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">nr_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">z_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z_count</span> <span class="o">=</span> <span class="n">image_properties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;zcount&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;the number of slices in the z-stack &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; zcount.</span><span class="se">\n</span><span class="s2">&quot;</span>
                         <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">pixel_size</span> <span class="o">=</span> <span class="n">image_properties</span><span class="p">[</span><span class="s1">&#39;PixelSize&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;ImageProperties[&#39;PixelSize&#39;] not found in &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;experimental metadata file.</span><span class="se">\n</span><span class="s2">Please add the &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;size of a pixel in um in the experimental &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;--&gt; PixelSize.</span><span class="se">\n</span><span class="s2">KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span>
    <span class="c1"># Estimate the overlap in pixels with the overlap that the user</span>
    <span class="c1"># provided, default is 10%</span>
    <span class="n">est_x_tol</span> <span class="o">=</span> <span class="n">nr_pixels</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">est_overlap</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Estimating overlap at </span><span class="si">{}</span><span class="s2">%, that is </span><span class="si">{}</span><span class="s2"> pixels&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">est_overlap</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">est_x_tol</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Number of pixels: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nr_pixels</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Number of slices in z-stack: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z_count</span><span class="p">))</span>

    <span class="c1"># Organize the microscope data and determine tile set</span>
    <span class="n">micData</span> <span class="o">=</span> <span class="n">MicroscopeData</span><span class="p">(</span><span class="n">coord_data</span><span class="p">,</span> <span class="n">y_flip</span><span class="p">,</span> <span class="n">nr_dim</span><span class="p">)</span>
    <span class="n">micData</span><span class="o">.</span><span class="n">normalize_coords</span><span class="p">(</span><span class="n">pixel_size</span><span class="p">)</span>
    <span class="n">micData</span><span class="o">.</span><span class="n">make_tile_set</span><span class="p">(</span><span class="n">est_x_tol</span><span class="p">,</span> <span class="n">nr_pixels</span> <span class="o">=</span> <span class="n">nr_pixels</span><span class="p">)</span>

    <span class="c1"># Make a list of image numbers, matching with the numbers in the</span>
    <span class="c1"># image files</span>
    <span class="n">flat_tile_set</span> <span class="o">=</span> <span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>

    <span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_nr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">flat_tile_set</span><span class="p">]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting references for: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_list</span><span class="p">))</span>


    <span class="c1"># Make a list of the image names (-1 is a missing tile)</span>
    <span class="n">tiles</span> <span class="o">=</span> <span class="n">image_list</span><span class="o">.</span><span class="n">data</span>


    <span class="c1"># Produce an undirected graph of the tiles, tiles that are</span>
    <span class="c1"># neighbours to each other are connected in this graph.</span>
    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sklim</span><span class="o">.</span><span class="n">grid_to_graph</span><span class="p">(</span><span class="o">*</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span> <span class="n">C</span> <span class="p">)</span>
    <span class="c1"># Extract the neighbour pairs from the graph</span>
    <span class="n">contig_tuples</span> <span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">C</span> <span class="p">)</span> <span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Length contingency tuples: </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Contingency tuples: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contig_tuples</span><span class="p">),</span> <span class="n">contig_tuples</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">tiles</span><span class="p">,</span> <span class="n">contig_tuples</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">,</span> <span class="n">micData</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_place_tile_input_apply_npy"><a class="viewcode-back" href="../../../API/stitching/stitching_ref.html#pysmFISH.stitching_package.stitching.get_place_tile_input_apply_npy">[docs]</a><span class="k">def</span> <span class="nf">get_place_tile_input_apply_npy</span><span class="p">(</span><span class="n">hyb_dir</span><span class="p">,</span><span class="n">stitched_reference_files_dir</span><span class="p">,</span><span class="n">data_name</span><span class="p">,</span><span class="n">image_properties</span><span class="p">,</span><span class="n">nr_dim</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modified version of the get_place_tile_input_apply</span>
<span class="sd">    Get the data needed to apply stitching to another gene</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    hyb_dir: str</span>
<span class="sd">        String representing the path of the folder containing</span>
<span class="sd">        the tile file, the stitching data file the yaml metadata file.</span>
<span class="sd">    stitched_reference_files_dir: str</span>
<span class="sd">        String representing the path of the folder containing the registered data.</span>
<span class="sd">    data_name: str  </span>
<span class="sd">        Name of the file containing the pickled stitching data.</span>
<span class="sd">    image_properties: dict</span>
<span class="sd">        Dictionary with the image details parsed from the Experimental_metadata.yaml file</span>
<span class="sd">    nr_dim: int</span>
<span class="sd">        If 3, the code will assume three dimensional data</span>
<span class="sd">        for the tile, where z is the first dimension and y and x</span>
<span class="sd">        the second and third. For any other value 2-dimensional data</span>
<span class="sd">        is assumed. (Default: 2)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    joining: dict</span>
<span class="sd">        Taken from the stitching data file.</span>
<span class="sd">        Contains keys corner_list and final_image_shape.</span>
<span class="sd">        Corner_list is a list of list, each list is a pair</span>
<span class="sd">        of an image number (int) and it&#39;s coordinates (numpy</span>
<span class="sd">        array containing floats).</span>
<span class="sd">        Final_image_shape is a tuple of size 2 or 3</span>
<span class="sd">        depending on the numer of dimensions and contains</span>
<span class="sd">        ints.</span>
<span class="sd">    tiles: list</span>
<span class="sd">        List of strings. List of references to the the tiles in the hdf5 file tile_file.</span>
<span class="sd">    nr_pixels: int</span>
<span class="sd">        Height and length of the tile in pixels, tile is assumed to be square.</span>
<span class="sd">    z_count: int</span>
<span class="sd">        The number of layers in one tile (size of the z-axis). Is 1 when nr_dim is not 3.</span>
<span class="sd">    micData: object</span>
<span class="sd">        MicroscopeData object. Taken from the pickled stitching data.</span>
<span class="sd">        Contains coordinates of the tile corners as taken from the microscope.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting data to apply stitching from file...&quot;</span><span class="p">)</span>

    <span class="c1"># Load image list and old joining data</span>
    <span class="n">stitching_coord_dict</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">load_stitching_coord</span><span class="p">(</span><span class="n">stitched_reference_files_dir</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">)</span>
    <span class="c1"># noinspection PyPep8Naming</span>
    <span class="n">micData</span> <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;micData&#39;</span><span class="p">]</span>
    <span class="n">joining</span> <span class="o">=</span> <span class="n">stitching_coord_dict</span><span class="p">[</span><span class="s1">&#39;joining&#39;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining object and image list loaded from file&quot;</span><span class="p">)</span>
    
    <span class="c1"># Make a list of image numbers</span>
    <span class="n">flat_tile_set</span> <span class="o">=</span> <span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">flat</span><span class="p">[:]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_nr</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">flat_tile_set</span><span class="p">]</span>
    <span class="n">image_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">image_list</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Tile set size: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">micData</span><span class="o">.</span><span class="n">tile_set</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Placing folowing image references in tiles: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image_list</span><span class="p">))</span>
    
    <span class="c1"># Make a list of the image names (-1 is a missing tile)</span>
    <span class="n">tiles</span> <span class="o">=</span> <span class="n">image_list</span><span class="o">.</span><span class="n">data</span>
    
    
    <span class="c1"># Read the number of pixels and z-count from the yaml</span>
    <span class="c1"># file.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">nr_pixels</span> <span class="o">=</span> <span class="n">image_properties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">((</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;the number of pixels in an image &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; rows.</span><span class="se">\n</span><span class="s2">&quot;</span>
                     <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span>

    <span class="k">if</span> <span class="n">nr_dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">z_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">z_count</span> <span class="o">=</span> <span class="n">image_properties</span><span class="p">[</span><span class="s1">&#39;HybImageSize&#39;</span><span class="p">][</span><span class="s1">&#39;zcount&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="p">(</span><span class="s2">&quot;Number of pixels not found in experimental &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;metadata file.</span><span class="se">\n</span><span class="s2">Please add &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;the number of slices in the z-stack &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;to the experimental &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;metadata file under ImageProperties &quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;--&gt; HybImageSize --&gt; zcount.</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="o">+</span> <span class="s2">&quot;KeyError: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Size tiles: </span><span class="si">{}</span><span class="s2"> Number of pixels: </span><span class="si">{}</span><span class="s2"> z count: </span><span class="si">{}</span><span class="s2">&quot;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span> <span class="n">tiles</span><span class="p">),</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">))</span>


    <span class="k">return</span> <span class="p">(</span><span class="n">joining</span><span class="p">,</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">nr_pixels</span><span class="p">,</span> <span class="n">z_count</span><span class="p">,</span> <span class="n">micData</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, simone codeluppi.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>