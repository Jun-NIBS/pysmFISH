

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pysmFISH.stitching_package.hybregistration &mdash; pysmFISH 0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="pysmFISH 0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> pysmFISH
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Welcome to pysmFISH!</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/index.html">Installation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cluster/index.html">Cluster setup</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../API/index.html">API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline/index.html">Processing pipeline</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../license/index.html">License</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../citing/index.html">Author and citations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../ind_tables/index.html">Indices and Tables</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pysmFISH</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pysmFISH.stitching_package.hybregistration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pysmFISH.stitching_package.hybregistration</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Functions to perform registration between all hybridizations.</span>

<span class="sd">register_final_images(folder, gene=&#39;Nuclei&#39;,</span>
<span class="sd">                      sub_pic_frac=0.2, use_MPI=False,</span>
<span class="sd">                      apply_to_corners=True, apply_warping = True)</span>
<span class="sd">        -- Register stitched images an in all  HDF5 file in the folder</span>
<span class="sd">find_reg_final_image(im_file_1, im_file_n,</span>
<span class="sd">                           max_trans, sub_pic_frac,</span>
<span class="sd">                           nr_peaks=8)</span>
<span class="sd">        -- Find the transform that registers image n correctly onto</span>
<span class="sd">        image 1.</span>
<span class="sd">transform_final_image(im_file_n, trans, new_size)</span>
<span class="sd">        -- Transform an image according to trans.</span>
<span class="sd">transform_data_file(folder, data_name, trans,</span>
<span class="sd">                        new_size)</span>
<span class="sd">        -- Transform the corners in the pickled data file</span>
<span class="sd">align_sub_region(overlap1, overlap2, nr_peaks)</span>
<span class="sd">        -- Determine how much overlap2 should be shifted to fit</span>
<span class="sd">        overlap1, help function for find_reg_final_image</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">skimage.transform</span> <span class="k">as</span> <span class="nn">smtf</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>
    <span class="n">MPI_available</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">MPI_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="c1"># Own imports</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">inout</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">pairwisesingle</span> <span class="k">as</span> <span class="n">ps</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="register_final_images"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.register_final_images">[docs]</a><span class="k">def</span> <span class="nf">register_final_images</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="o">=</span><span class="s1">&#39;Nuclei&#39;</span><span class="p">,</span>
                          <span class="n">sub_pic_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">use_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">apply_to_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_warping</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register stitched images an in all  HDF5 file in the folder</span>

<span class="sd">    Loops the hybridizations in the HDF5 file, takes the stitched</span>
<span class="sd">    images as indicated by gene and then compares each image to the</span>
<span class="sd">    first image.</span>
<span class="sd">    For the comparison only a small patch of the images is used, the</span>
<span class="sd">    size of this patch can be controlled with &quot;sub_pic_frac&quot;.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        The name of the folder containing the pickled file with stitching data, </span>
<span class="sd">        needs a trailing slash (&quot;/&quot;).</span>
<span class="sd">    gene: str </span>
<span class="sd">        The gene of which the stitched images are present and should be realigned.</span>
<span class="sd">        Typically this will be &#39;Nuclei&#39;, because the smFISH genes will not have </span>
<span class="sd">        enough signal to align the pictures properly. (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    sub_pic_frac: float </span>
<span class="sd">        The fraction of the size of the original image that should be used to compare</span>
<span class="sd">        images. (Default: 0.2)</span>
<span class="sd">    use_MPI: bool </span>
<span class="sd">        If True open the files in MPI friendly mode, if False open files in normal</span>
<span class="sd">        single processing mode. (Default: False)</span>
<span class="sd">    apply_to_corners: bool</span>
<span class="sd">        Determines if the found registration will be applied to the tile</span>
<span class="sd">        corners in the pickled stitching data file. (Default: True)</span>
<span class="sd">    apply_warping: bool</span>
<span class="sd">        Determines if the found registration will be applied as a warp to the</span>
<span class="sd">        final pictures in the hdf5 file, should not be used with large datasets.</span>
<span class="sd">        (Default: False)</span>
<span class="sd">    region: list </span>
<span class="sd">        List of length four containing ints. The region that should be compared to determine</span>
<span class="sd">        the shift needed for registration. Should be in the order: [y_min, y_max, x_min,</span>
<span class="sd">        x_max]. When region is defined, sub_pic_frac will not be used.</span>
<span class="sd">        By default the code will determine the region itself taking a area around the</span>
<span class="sd">        center of the image with a size determined by sub_pic_frac(Default: None)</span>
<span class="sd">    compare_in_seq: bool </span>
<span class="sd">        Determines if we should compare images in sequence or if we should compare</span>
<span class="sd">        all to the first image.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compare_in_seq</span><span class="p">:</span>
        <span class="n">file_name_list</span><span class="p">,</span> <span class="n">file_1</span><span class="p">,</span> <span class="n">im_file_1</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">,</span> \
            <span class="n">max_trans</span> <span class="o">=</span> \
            <span class="n">prepare_for_comparing</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="p">,</span>
                                  <span class="n">use_MPI</span><span class="o">=</span><span class="n">use_MPI</span><span class="p">)</span>
        <span class="c1"># Compare each file to file 1:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
            <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span><span class="p">,</span> <span class="n">file_ind</span> <span class="o">=</span> \
                <span class="n">get_single_trans</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">im_file_1</span><span class="p">,</span>
                                 <span class="n">max_trans</span><span class="p">,</span> <span class="n">sub_pic_frac</span><span class="o">=</span><span class="n">sub_pic_frac</span><span class="p">,</span>
                                 <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">use_MPI</span><span class="o">=</span><span class="n">use_MPI</span><span class="p">)</span>
            <span class="n">trans</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cur_trans</span>
            <span class="n">old_size_list</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cur_old_size</span>
        <span class="c1"># Close the hdf5 file.</span>
        <span class="n">file_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">trans</span><span class="p">,</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">correct_trans_and_size</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span>
                                                 <span class="n">old_size_list</span><span class="p">,</span>
                                                 <span class="n">max_trans</span><span class="p">,</span>
                                                 <span class="n">compare_in_seq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_name_list</span><span class="p">,</span> <span class="n">trans_relative</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">,</span> <span class="n">max_trans</span> <span class="o">=</span> \
            <span class="n">prepare_for_comparing</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="p">,</span>
                                  <span class="n">use_MPI</span><span class="o">=</span><span class="n">use_MPI</span><span class="p">)</span>
        <span class="c1"># Compare each file to previous file:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
            <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span><span class="p">,</span> <span class="n">file_ind</span> <span class="o">=</span> \
                <span class="n">get_single_relative_trans</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span>
                                          <span class="n">max_trans</span><span class="p">,</span>
                                          <span class="n">sub_pic_frac</span> <span class="o">=</span> <span class="n">sub_pic_frac</span><span class="p">,</span>
                                          <span class="n">region</span> <span class="o">=</span> <span class="n">region</span><span class="p">,</span>
                                          <span class="n">use_MPI</span> <span class="o">=</span> <span class="n">use_MPI</span><span class="p">)</span>
            <span class="n">trans_relative</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cur_trans</span>
            <span class="n">old_size_list</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">=</span> <span class="n">cur_old_size</span>
        <span class="n">trans</span><span class="p">,</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">correct_trans_and_size</span><span class="p">(</span><span class="n">trans_relative</span><span class="p">,</span>
                                                 <span class="n">old_size_list</span><span class="p">,</span>
                                                 <span class="n">max_trans</span><span class="p">,</span>
                                                 <span class="n">compare_in_seq</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;Files: </span><span class="si">{}</span><span class="s1"> Translations: </span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">trans</span><span class="p">))</span>

    <span class="c1"># Apply the translations</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">apply_warping</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
                <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                                   <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">im_file_n</span> <span class="o">=</span> <span class="n">file_n</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
            <span class="n">transform_final_image</span><span class="p">(</span><span class="n">im_file_n</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">new_size</span><span class="p">)</span>
            <span class="n">file_n</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">apply_to_corners</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">gene</span>
            <span class="o">+</span> <span class="s1">&#39;_stitching_data&#39;</span><span class="p">)</span>
            <span class="n">transform_data_file</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span></div>
                                <span class="n">new_size</span><span class="p">)</span>

<div class="viewcode-block" id="prepare_for_comparing"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.prepare_for_comparing">[docs]</a><span class="k">def</span> <span class="nf">prepare_for_comparing</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="p">,</span> <span class="n">use_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare the file list, first file and init other lists.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str         </span>
<span class="sd">        The name of the folder containing the</span>
<span class="sd">        pickled file with stitching data, needs a</span>
<span class="sd">        trailing slash (&quot;/&quot;).</span>
<span class="sd">    gene: str</span>
<span class="sd">        The gene of which the stitched</span>
<span class="sd">        images are present and should be realigned.</span>
<span class="sd">        Typically this will be &#39;Nuclei&#39;, because the</span>
<span class="sd">        smFISH genes will not have enough signal to</span>
<span class="sd">        align the pictures properly.</span>
<span class="sd">        (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    compare_in_seq: bool</span>
<span class="sd">        Determines if we should compare</span>
<span class="sd">        images in sequence or if we should compare</span>
<span class="sd">        all to the first image.</span>
<span class="sd">    use_MPI: bool</span>
<span class="sd">        If True open the files in MPI</span>
<span class="sd">        friendly mode, if False open files in normal</span>
<span class="sd">        single processing mode. (Default: False)</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    file_name_list: list</span>
<span class="sd">        List of strings. List of the sf.hdf5-files in the folder.</span>
<span class="sd">    trans: np.array</span>
<span class="sd">        Array of ints. The array to store the translations, initialized with zeros.</span>
<span class="sd">    old_size_list: np.array </span>
<span class="sd">        Array of ints. The array to store the sizes of the final images, initialized with</span>
<span class="sd">        zeros.</span>
<span class="sd">    max_trans: np.array</span>
<span class="sd">        Array of ints. Variable to store the</span>
<span class="sd">        largest translation found up to now,</span>
<span class="sd">        initialized at zero.</span>
<span class="sd">    </span>
<span class="sd">    Notes:</span>
<span class="sd">    ------</span>
<span class="sd">    Only returned if compare_in_seq is True:</span>
<span class="sd">    file_1: pointer</span>
<span class="sd">        File handle to the first hdf5 file in the folder.</span>
<span class="sd">    im_file_1: pointer</span>
<span class="sd">        Reference to the group in   the first file that contains th final image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get a list of files in the folder</span>
    <span class="n">file_name_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;*.sf.hdf5&#39;</span><span class="p">)</span>
    <span class="n">file_name_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Filenames sorted: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">))</span>
    <span class="c1"># Initialize some variables:</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">old_size_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">max_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Take the first hybridization (keys() seems to give the groups</span>
    <span class="c1"># as a sorted list)</span>
    <span class="n">im_name_1</span> <span class="o">=</span> <span class="n">file_name_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;im_name_1: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">im_name_1</span><span class="p">))</span>
    <span class="c1"># Open the stitching file and make a list of the hybridizations</span>
    <span class="c1"># present in this file:</span>
    <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
        <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_name_1</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                           <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_name_1</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>

    <span class="c1"># hyb_name_list = list(stitching_file.keys())</span>

    <span class="c1"># Get the right group</span>
    <span class="n">im_file_1</span> <span class="o">=</span> <span class="n">file_1</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
    <span class="c1"># Get the size of the first image in the list,</span>
    <span class="c1"># which will be the reference image without translation.</span>
    <span class="n">old_size_list</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Make comparisons</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compare_in_seq</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">file_name_list</span><span class="p">,</span> <span class="n">file_1</span><span class="p">,</span> <span class="n">im_file_1</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> \
               <span class="n">old_size_list</span><span class="p">,</span> <span class="n">max_trans</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get the size for the first image</span>
        <span class="n">file_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
        <span class="k">return</span> <span class="n">file_name_list</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">,</span> <span class="n">max_trans</span>


<div class="viewcode-block" id="get_single_trans"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.get_single_trans">[docs]</a><span class="k">def</span> <span class="nf">get_single_trans</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span>
                     <span class="n">im_file_1</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">sub_pic_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the translation between image 1 and image i.</span>

<span class="sd">    Get the translation between the image in file 1 and file i</span>
<span class="sd">    from file_name_list.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    file_name_list: list</span>
<span class="sd">        List of strings. List of the sf.hdf5-files in the folder.</span>
<span class="sd">    i: int</span>
<span class="sd">        Index of the current file to compare.</span>
<span class="sd">    gene: str</span>
<span class="sd">        Gene of which the stitched</span>
<span class="sd">        images are present and should be realigned.</span>
<span class="sd">        Typically this will be &#39;Nuclei&#39;, because the</span>
<span class="sd">        smFISH genes will not have enough signal to</span>
<span class="sd">        align the pictures properly.</span>
<span class="sd">        (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    im_file_1: pointer</span>
<span class="sd">        Reference to the group in the first file that contains th final image.</span>
<span class="sd">    max_trans: np.array</span>
<span class="sd">        Variable to store the largest translation found up to now,</span>
<span class="sd">        initialized at zero.</span>
<span class="sd">    sub_pic_frac: float</span>
<span class="sd">        The fraction of the size of the original image that should be used to compare</span>
<span class="sd">        images. (Default: 0.2)</span>
<span class="sd">    region: list</span>
<span class="sd">        List of length four containing ints. The</span>
<span class="sd">        region that should be compared to determine</span>
<span class="sd">        the shift needed for registration.</span>
<span class="sd">        Should be in the order: [y_min, y_max, x_min,</span>
<span class="sd">        x_max]. When region is defined, sub_pic_frac</span>
<span class="sd">        will not be used.</span>
<span class="sd">        By default the code will determine the region</span>
<span class="sd">        itself taking a area around the</span>
<span class="sd">        center of the image with a size</span>
<span class="sd">        determined by sub_pic_frac(Default: None)</span>
<span class="sd">    use_MPI: bool</span>
<span class="sd">        If True open the files in MPI friendly mode, if False open files in normal</span>
<span class="sd">        single processing mode. (Default: False)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    cur_trans: np.array</span>
<span class="sd">        Array of ints. Translation found between the two images that are currently</span>
<span class="sd">        being compared.</span>
<span class="sd">    max_trans: np.array </span>
<span class="sd">        Array of ints. The largest translation found up to now.</span>
<span class="sd">    cur_old_size: np.array</span>
<span class="sd">        Array of ints. The sizes of the original final image found in file_name_list</span>
<span class="sd">        at index i.</span>
<span class="sd">    i: int</span>
<span class="sd">        The index of the second image file used for the current comparison (The first image</span>
<span class="sd">        file is file 1).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the group containing the image we want to compare with.</span>
    <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
        <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                           <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
    <span class="n">im_file_n</span> <span class="o">=</span> <span class="n">file_n</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
    <span class="c1"># Find the translation</span>
    <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span> \
        <span class="o">=</span> <span class="n">find_reg_final_image</span><span class="p">(</span><span class="n">im_file_1</span><span class="p">,</span> <span class="n">im_file_n</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span>
                               <span class="n">sub_pic_frac</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;max_trans: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_trans</span><span class="p">))</span>
    <span class="n">file_n</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    <span class="k">return</span> <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span><span class="p">,</span> <span class="n">i</span>

<div class="viewcode-block" id="get_single_relative_trans"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.get_single_relative_trans">[docs]</a><span class="k">def</span> <span class="nf">get_single_relative_trans</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span>
                              <span class="n">sub_pic_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">use_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the translation between image i - 1 and image i.</span>

<span class="sd">    Get the translation between the image in file_name_list[i - 1] and</span>
<span class="sd">    file_name_list[i].</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    file_name_list: list</span>
<span class="sd">        List of strings. List of the sf.hdf5-files in the folder.</span>
<span class="sd">    i: int</span>
<span class="sd">        Index of the second image in the current comparison.</span>
<span class="sd">    gene: str</span>
<span class="sd">        The gene of which the stitched</span>
<span class="sd">        images are present and should be realigned.</span>
<span class="sd">        Typically this will be &#39;Nuclei&#39;, because the</span>
<span class="sd">        smFISH genes will not have enough signal to</span>
<span class="sd">        align the pictures properly.</span>
<span class="sd">        (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    max_trans: np.array</span>
<span class="sd">        Array of ints. Variable to store the</span>
<span class="sd">        largest translation found up to now,</span>
<span class="sd">        initialized at zero.</span>
<span class="sd">    sub_pic_frac: float</span>
<span class="sd">        The fraction of the size of the original image that should be used to compare</span>
<span class="sd">        images. (Default: 0.2)</span>
<span class="sd">    region: list</span>
<span class="sd">        List of length four containing ints. The</span>
<span class="sd">        region that should be compared to determine</span>
<span class="sd">        the shift needed for registration.</span>
<span class="sd">        Should be in the order: [y_min, y_max, x_min,</span>
<span class="sd">        x_max]. When region is defined, sub_pic_frac</span>
<span class="sd">        will not be used.</span>
<span class="sd">        By default the code will determine the region</span>
<span class="sd">        itself taking a area around the</span>
<span class="sd">        center of the image with a size</span>
<span class="sd">        determined by sub_pic_frac (Default: None)</span>
<span class="sd">    use_MPI: bool</span>
<span class="sd">        If True open the files in MPI</span>
<span class="sd">        friendly mode, if False open files in normal</span>
<span class="sd">        single processing mode. (Default: False)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    cur_trans: np.array</span>
<span class="sd">        Array of ints. Translation found between the two images that are currently</span>
<span class="sd">        being compared.</span>
<span class="sd">    max_trans: np.array</span>
<span class="sd">        Array of ints. The largest translation found up to now.</span>
<span class="sd">    cur_old_size: np.array</span>
<span class="sd">        The sizes of the original final image found in file_name_list</span>
<span class="sd">        at index i.</span>
<span class="sd">    i: int</span>
<span class="sd">        The index of the second image file used for the current comparison (The first image</span>
<span class="sd">        file is file 1).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the group containing the image we want to compare with.</span>
    <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
        <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                           <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
        <span class="n">file_2</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                           <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
        <span class="n">file_2</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
    <span class="n">im_file_1</span> <span class="o">=</span> <span class="n">file_1</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
    <span class="n">im_file_2</span> <span class="o">=</span> <span class="n">file_2</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
    <span class="c1"># Find the translation</span>
    <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span> \
        <span class="o">=</span> <span class="n">find_reg_final_image</span><span class="p">(</span><span class="n">im_file_1</span><span class="p">,</span> <span class="n">im_file_2</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span>
                               <span class="n">sub_pic_frac</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;max_trans: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_trans</span><span class="p">))</span>
    <span class="n">file_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">file_2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    <span class="k">return</span> <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span><span class="p">,</span> <span class="n">i</span>


<div class="viewcode-block" id="correct_trans_and_size"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.correct_trans_and_size">[docs]</a><span class="k">def</span> <span class="nf">correct_trans_and_size</span><span class="p">(</span><span class="n">trans_relative</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span>
                           <span class="n">compare_in_seq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Correct the translations and the size of the registered images.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    trans_relative: np.array</span>
<span class="sd">        Array of ints. The array with the non-corrected translation.</span>
<span class="sd">    old_size_list: np.array</span>
<span class="sd">        Array of ints. The array with the sizes of all the final,</span>
<span class="sd">        non-registered images.</span>
<span class="sd">    max_trans: np.array</span>
<span class="sd">        Array of ints. Variable to store the largest translation found up to now.</span>
<span class="sd">    compare_in_seq: bool</span>
<span class="sd">        Determines if we should compare images in sequence or if we should compare</span>
<span class="sd">        all to the first image.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    trans: np.array</span>
<span class="sd">        Array of ints. The array with the corrected translations for each image.</span>
<span class="sd">    new_size: np.array </span>
<span class="sd">        Array of length 2 containing ints. The size the images should have after registration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">compare_in_seq</span><span class="p">:</span>
        <span class="c1"># Get the normalized transistions</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">trans_relative</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="s2">&quot;Comparing in sequence: relative translations: &quot;</span>
                      <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> normalized translations: </span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trans_relative</span><span class="p">,</span> <span class="n">trans</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;max_trans: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_trans</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">trans_relative</span>

    <span class="c1"># Correct translations</span>
    <span class="n">trans</span> <span class="o">-=</span> <span class="n">max_trans</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;old_size_list: </span><span class="si">{}</span><span class="s1">&#39;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_size_list</span><span class="p">))</span>
    <span class="c1"># Determine final image size:</span>
    <span class="n">new_size_list</span> <span class="o">=</span> <span class="n">old_size_list</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">new_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">new_size_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;new_size_list: </span><span class="si">{}</span><span class="s1">  new_size: </span><span class="si">{}</span><span class="s1">&#39;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_size_list</span><span class="p">,</span> <span class="n">new_size</span><span class="p">))</span></div>
    <span class="k">return</span> <span class="n">trans</span><span class="p">,</span> <span class="n">new_size</span>


<div class="viewcode-block" id="find_reg_final_image"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.find_reg_final_image">[docs]</a><span class="k">def</span> <span class="nf">find_reg_final_image</span><span class="p">(</span><span class="n">im_file_1</span><span class="p">,</span> <span class="n">im_file_n</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">sub_pic_frac</span><span class="p">,</span>
                         <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nr_peaks</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the transform that registers image n correctly onto image 1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    im_file_1: pointer</span>
<span class="sd">        HDF5 group reference or file handle, should</span>
<span class="sd">        contain a dataset &quot;final_image&quot; holding image 1.</span>
<span class="sd">    im_name_n: pointer</span>
<span class="sd">        HDF5 group reference or file handle, should</span>
<span class="sd">        contain a dataset &quot;final_image&quot; holding image n.</span>
<span class="sd">    max_trans: np.array</span>
<span class="sd">        Array of length 2 with dtype: int.</span>
<span class="sd">        Largest translation currently found.</span>
<span class="sd">    sub_pic_frac: float </span>
<span class="sd">        The fraction of the size of the original </span>
<span class="sd">        image that should be used to compare images.</span>
<span class="sd">    region: list</span>
<span class="sd">        List of length four containing ints. The</span>
<span class="sd">        region that should be compared to determine</span>
<span class="sd">        the shift needed for registration.</span>
<span class="sd">        Should be in the order: [y_min, y_max, x_min,</span>
<span class="sd">        x_max]. When region is defined, sub_pic_frac</span>
<span class="sd">        will not be used.</span>
<span class="sd">        By default the code will determine the region</span>
<span class="sd">        itself taking a area around the</span>
<span class="sd">        center of the image with a size</span>
<span class="sd">        determined by sub_pic_frac(Default: None)</span>
<span class="sd">    nr_peaks: int        </span>
<span class="sd">        The number of peaks used to get the best peaks </span>
<span class="sd">        from the phase correlation matrix. (default: 8)</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    trans: np.array</span>
<span class="sd">        Array of length 2 containing ints.</span>
<span class="sd">        Translation that projects image n correctly onto image 1.</span>
<span class="sd">    max_trans: np.array</span>
<span class="sd">        Array of shape (1, 2) containing ints.</span>
<span class="sd">        The max_trans value that was passed to this</span>
<span class="sd">        function, replaced by (part of) the current</span>
<span class="sd">        translation if it is larger than max_trans.</span>
<span class="sd">    shape_n: tuple</span>
<span class="sd">        Tuple of python ints. The shape of image n.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the image shapes</span>
    <span class="n">shape_1</span> <span class="o">=</span> <span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shape_n</span> <span class="o">=</span> <span class="n">im_file_n</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>

    <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Determine the size of the part of the picture that we want to compare</span>
        <span class="n">sub_pic_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape_1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sub_pic_frac</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span>
                                                                 <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sub_pic_size: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub_pic_size</span><span class="p">))</span>
        <span class="c1"># Take the center coordinates in the y and x axes</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shape_1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                   <span class="n">shape_n</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))),</span>
                  <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">shape_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                                   <span class="n">shape_n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))))</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">sub_pic_size</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                            <span class="n">shape_1</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                            <span class="n">shape_n</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sub_pic_size</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">shape_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">shape_n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">end</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">region</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Area based on given region: Start: </span><span class="si">{}</span><span class="s2"> &quot;</span>
                     <span class="s2">&quot;End: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
    <span class="c1"># Get the region to compare from the pictures</span>
    <span class="k">if</span> <span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">pic_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">][:,</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pic_1</span> <span class="o">=</span> <span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">][</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">pic_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">im_file_n</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">][:,</span> <span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pic_n</span> <span class="o">=</span> <span class="n">im_file_n</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">][</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">end</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="c1"># Find the best translation</span>
    <span class="n">trans</span><span class="p">,</span> <span class="n">best_cov</span> <span class="o">=</span> <span class="n">align_sub_region</span><span class="p">(</span><span class="n">pic_1</span><span class="p">,</span> <span class="n">pic_n</span><span class="p">,</span> <span class="n">nr_peaks</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found trans: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n</span><span class="s1"> best covariance: </span><span class="si">{}</span><span class="s1">&#39;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">best_cov</span><span class="p">))</span>
    <span class="c1"># Adjust max trans if necessary</span>
    <span class="n">max_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">max_trans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trans</span><span class="p">))</span>
</div>
    <span class="k">return</span> <span class="n">trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">shape_n</span>


<div class="viewcode-block" id="transform_final_image"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.transform_final_image">[docs]</a><span class="k">def</span> <span class="nf">transform_final_image</span><span class="p">(</span><span class="n">im_file_n</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">new_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform an image according to trans.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    im_file_n: pointer </span>
<span class="sd">        HDF5 group reference or file handle, should</span>
<span class="sd">        contain a dataset &quot;final_image&quot; holding image n.</span>
<span class="sd">    trans: np.array</span>
<span class="sd">        Array of len 2 containing ints. y and x transform of the image.</span>
<span class="sd">    new_size: tuple</span>
<span class="sd">        Tuple of length 2. The size of the image after the transform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make the trans matrix</span>
    <span class="n">trans_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">trans_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">trans_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">trans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Make a separate dataset for the registered image.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;new_size </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_size</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">registered_image</span> <span class="o">=</span> <span class="n">im_file_n</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s1">&#39;reg_image&#39;</span><span class="p">,</span>
                                             <span class="n">shape</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_size</span><span class="p">),</span>
                                             <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;Incompatible data set for reg_image, deleting old &quot;</span> <span class="o">+</span>
             <span class="s2">&quot;dataset. N.B: Not cleaning up space. </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">im_file_n</span><span class="p">[</span><span class="s1">&#39;reg_image&#39;</span><span class="p">]</span>
        <span class="n">registered_image</span> <span class="o">=</span> <span class="n">im_file_n</span><span class="o">.</span><span class="n">require_dataset</span><span class="p">(</span><span class="s1">&#39;reg_image&#39;</span><span class="p">,</span>
                                                 <span class="n">shape</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_size</span><span class="p">),</span>
                                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c1"># Transform the image</span>
    <span class="n">registered_image</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">smtf</span><span class="o">.</span><span class="n">warp</span><span class="p">(</span><span class="n">im_file_n</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">],</span>
                                   <span class="n">trans_matrix</span><span class="p">,</span></div>
                                   <span class="n">output_shape</span><span class="o">=</span><span class="n">new_size</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<div class="viewcode-block" id="transform_data_file"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.transform_data_file">[docs]</a><span class="k">def</span> <span class="nf">transform_data_file</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span>
                        <span class="n">new_size</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform the corners in the pickled data file</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        The name of the folder containing the</span>
<span class="sd">        pickled file with stitching data, needs a</span>
<span class="sd">        trailing slash (&quot;/&quot;).</span>
<span class="sd">    data_name: str</span>
<span class="sd">        Name of the pickled file with the corner coordinates.</span>
<span class="sd">    trans: np.array</span>
<span class="sd">        Array of len 2 containing ints. y and x transform of the image.</span>
<span class="sd">    new_size: tuple</span>
<span class="sd">        Tuple of length 2. The size of the image after the transform.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Determine the name to safe the new pickled data file.</span>
    <span class="n">exp_name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Get the original coordinates</span>
    <span class="n">loaded_data</span> <span class="o">=</span> <span class="n">inout</span><span class="o">.</span><span class="n">load_stitching_coord</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">data_name</span><span class="p">)</span>
    <span class="n">micData</span> <span class="o">=</span> <span class="n">loaded_data</span><span class="p">[</span><span class="s1">&#39;micData&#39;</span><span class="p">]</span>
    <span class="n">joining_original</span> <span class="o">=</span> <span class="n">loaded_data</span><span class="p">[</span><span class="s1">&#39;joining&#39;</span><span class="p">]</span>
    <span class="n">joining_new</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Translate the corners</span>
    <span class="n">temp_corner_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">tile_ind</span><span class="p">,</span> <span class="p">(</span><span class="n">corner</span> <span class="o">-</span> <span class="n">trans</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">tile_ind</span><span class="p">,</span> <span class="n">corner</span> <span class="ow">in</span>
                        <span class="n">joining_original</span><span class="p">[</span><span class="s1">&#39;corner_list&#39;</span><span class="p">]]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;temp_corner_list: </span><span class="si">{}</span><span class="s1"> trans: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp_corner_list</span><span class="p">,</span>
                                                <span class="n">trans</span><span class="p">))</span>
    <span class="c1"># Place the corners in the joining dictionary.</span>
    <span class="n">joining_new</span><span class="p">[</span><span class="s1">&#39;corner_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_corner_list</span>
    <span class="c1"># Change final image shape of original:</span>
    <span class="n">joining_new</span><span class="p">[</span><span class="s1">&#39;final_image_shape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_size</span>

    <span class="c1"># Save to a new file</span>
    <span class="n">inout</span><span class="o">.</span><span class="n">save_to_file</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="n">exp_name</span> <span class="o">+</span> <span class="s1">&#39;_stitching_data_reg&#39;</span><span class="p">,</span></div>
                       <span class="n">micData</span><span class="o">=</span><span class="n">micData</span><span class="p">,</span> <span class="n">joining</span><span class="o">=</span><span class="n">joining_new</span><span class="p">)</span>


<div class="viewcode-block" id="align_sub_region"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.align_sub_region">[docs]</a><span class="k">def</span> <span class="nf">align_sub_region</span><span class="p">(</span><span class="n">overlap1</span><span class="p">,</span> <span class="n">overlap2</span><span class="p">,</span> <span class="n">nr_peaks</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine how much overlap2 should be shifted to fit overlap1.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    overlap1: np.array</span>
<span class="sd">        2D numpy array. Patch of the image that should be compared.</span>
<span class="sd">    overlap2: np.array</span>
<span class="sd">        2D numpy array. Patch of the image that should be compared.</span>
<span class="sd">    nr_peaks: int</span>
<span class="sd">        The number of peaks used to get the best peaks from the phase correlation matrix.</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    --------</span>

<span class="sd">    best_trans: np.array</span>
<span class="sd">        Array of len 2 containing ints. Transform that projects overlap2 </span>
<span class="sd">        correctly onto overlap1.</span>
<span class="sd">    best_cov: float</span>
<span class="sd">        The normalized covariance</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">plot_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="c1"># Calculate possible translations</span>
    <span class="n">unr_pos_transistions</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">calculate_pos_shifts</span><span class="p">(</span>
        <span class="n">overlap1</span><span class="p">,</span> <span class="n">overlap2</span><span class="p">,</span> <span class="n">nr_peaks</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Possible translations: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="n">unr_pos_transistions</span><span class="p">))</span>
    <span class="c1"># Do correlation over the found shifts:</span>
    <span class="n">best_trans</span><span class="p">,</span> <span class="n">best_cov</span> <span class="o">=</span> <span class="n">ps</span><span class="o">.</span><span class="n">find_best_trans</span><span class="p">(</span><span class="n">unr_pos_transistions</span><span class="p">,</span>
                                              <span class="n">overlap1</span><span class="p">,</span> <span class="n">overlap2</span><span class="p">,</span>
                                              <span class="n">plot_order</span><span class="p">)</span>
    <span class="c1"># Give some feedback</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Best shift: </span><span class="si">{}</span><span class="s2"> covariance: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">best_trans</span><span class="p">,</span> <span class="n">best_cov</span><span class="p">))</span></div>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">best_trans</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int16&#39;</span><span class="p">),</span> <span class="n">best_cov</span>


<div class="viewcode-block" id="register_final_images_old"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.register_final_images_old">[docs]</a><span class="k">def</span> <span class="nf">register_final_images_old</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="o">=</span><span class="s1">&#39;Nuclei&#39;</span><span class="p">,</span>
                              <span class="n">sub_pic_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">use_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">apply_to_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">apply_warping</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register stitched images an in all  HDF5 file in the folder</span>

<span class="sd">    Loops the hybridizations in the HDF5 file, takes the stitched</span>
<span class="sd">    images as indicated by gene and then compares each image to the</span>
<span class="sd">    first image.</span>
<span class="sd">    For the comparison only a small patch of the images is used, the</span>
<span class="sd">    size of this patch can be controlled with &quot;sub_pic_frac&quot;.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        The name of the folder containing the</span>
<span class="sd">        pickled file with stitching data, needs a</span>
<span class="sd">        trailing slash (&quot;/&quot;).</span>
<span class="sd">    gene: str</span>
<span class="sd">        The gene of which the stitched</span>
<span class="sd">        images are present and should be realigned.</span>
<span class="sd">        Typically this will be &#39;Nuclei&#39;, because the</span>
<span class="sd">        smFISH genes will not have enough signal to</span>
<span class="sd">        align the pictures properly.</span>
<span class="sd">        (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    sub_pic_frac: float</span>
<span class="sd">        The fraction of the size of the</span>
<span class="sd">        original image that should be used to compare</span>
<span class="sd">        images.</span>
<span class="sd">        (Default: 0.2)</span>
<span class="sd">    use_MPI: bool</span>
<span class="sd">        True open the files in MPI friendly mode, if False open files in normal</span>
<span class="sd">        single processing mode. (Default: False)</span>
<span class="sd">    apply_to_corners: bool</span>
<span class="sd">        Determines if the found</span>
<span class="sd">        registration will be applied to the tile</span>
<span class="sd">        corners in the pickled stitching data file.</span>
<span class="sd">        (Default: True)</span>
<span class="sd">    apply_warping: bool</span>
<span class="sd">        Determines if the found</span>
<span class="sd">        registration will be applied as a warp to the</span>
<span class="sd">        final pictures in the hdf5 file, should not</span>
<span class="sd">        be used with large datasets.</span>
<span class="sd">        (Default: False)</span>
<span class="sd">    region: list</span>
<span class="sd">        List of length four containing ints. The</span>
<span class="sd">        region that should be compared to determine</span>
<span class="sd">        the shift needed for registration.</span>
<span class="sd">        Should be in the order: [y_min, y_max, x_min,</span>
<span class="sd">        x_max]. When region is defined, sub_pic_frac</span>
<span class="sd">        will not be used.</span>
<span class="sd">        By default the code will determine the region</span>
<span class="sd">        itself taking a area around the</span>
<span class="sd">        center of the image with a size</span>
<span class="sd">        determined by sub_pic_frac(Default: None)</span>
<span class="sd">    compare_in_seq: bool</span>
<span class="sd">        Determines if we should compare</span>
<span class="sd">        images in sequence or if we should compare</span>
<span class="sd">        all to the first image.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get a list of files in the folder</span>
    <span class="n">file_name_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">folder</span> <span class="o">+</span> <span class="s1">&#39;*.sf.hdf5&#39;</span><span class="p">)</span>
    <span class="n">file_name_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Filenames sorted: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">))</span>
    <span class="c1"># Initialize some variables:</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">old_size_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">max_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># Make comparisons</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compare_in_seq</span><span class="p">:</span>
        <span class="c1"># Take the first hybridization (keys() seems to give the groups</span>
        <span class="c1"># as a sorted list)</span>
        <span class="n">im_name_1</span> <span class="o">=</span> <span class="n">file_name_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;im_name_1: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">im_name_1</span><span class="p">))</span>
        <span class="c1"># Open the stitching file and make a list of the hybridizations</span>
        <span class="c1"># present in this file:</span>
        <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
            <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_name_1</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                               <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">im_name_1</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>

        <span class="c1"># hyb_name_list = list(stitching_file.keys())</span>

        <span class="c1"># Get the right group</span>
        <span class="n">im_file_1</span> <span class="o">=</span> <span class="n">file_1</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
        <span class="n">old_size_list</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># Compare each file to file 1:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
            <span class="c1"># Get the group containing the image we want to compare with.</span>
            <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
                <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                                   <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">im_file_n</span> <span class="o">=</span> <span class="n">file_n</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
            <span class="c1"># Find the translation</span>
            <span class="n">trans</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> \
                <span class="o">=</span> <span class="n">find_reg_final_image</span><span class="p">(</span><span class="n">im_file_1</span><span class="p">,</span> <span class="n">im_file_n</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span>
                                       <span class="n">sub_pic_frac</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;max_trans: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_trans</span><span class="p">))</span>
            <span class="n">file_n</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Close the hdf5 file.</span>
        <span class="n">file_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Init specific array</span>
        <span class="n">trans_relative</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># Compare each file to previous file:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
            <span class="c1"># Get the group containing the image we want to compare with.</span>
            <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
                <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                                   <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
                <span class="n">file_2</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                                   <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_1</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
                <span class="n">file_2</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">im_file_1</span> <span class="o">=</span> <span class="n">file_1</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
            <span class="n">im_file_2</span> <span class="o">=</span> <span class="n">file_2</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
            <span class="c1"># Get the size of the first image in the list,</span>
            <span class="c1"># which will be the reference image without translation.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">old_size_list</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">im_file_1</span><span class="p">[</span><span class="s1">&#39;final_image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="c1"># Find the translation</span>
            <span class="n">trans_relative</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> \
                <span class="o">=</span> <span class="n">find_reg_final_image</span><span class="p">(</span><span class="n">im_file_1</span><span class="p">,</span> <span class="n">im_file_2</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span>
                                       <span class="n">sub_pic_frac</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;max_trans: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_trans</span><span class="p">))</span>
            <span class="n">file_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">file_2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Get the normalized transistions</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">trans_relative</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">((</span><span class="s2">&quot;Comparing in sequence: relative translations: &quot;</span>
                      <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> normalized translations: </span><span class="se">\n</span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trans_relative</span><span class="p">,</span> <span class="n">trans</span><span class="p">)))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;max_trans: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_trans</span><span class="p">))</span>

    <span class="c1"># Correct translations</span>
    <span class="n">trans</span> <span class="o">-=</span> <span class="n">max_trans</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;old_size_list: </span><span class="si">{}</span><span class="s1">&#39;</span>
                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">old_size_list</span><span class="p">))</span>
    <span class="c1"># Determine final image size:</span>
    <span class="n">new_size_list</span> <span class="o">=</span> <span class="n">old_size_list</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>
    <span class="n">new_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">new_size_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;Files: </span><span class="si">{}</span><span class="s1"> Translations: </span><span class="si">{}</span><span class="s1"> new_size_list: </span><span class="si">{}</span><span class="s1"> new_size: </span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">new_size_list</span><span class="p">,</span> <span class="n">new_size</span><span class="p">))</span>
    <span class="c1"># Apply the translations</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">apply_warping</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_MPI</span><span class="p">:</span>
                <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span>
                                   <span class="n">driver</span><span class="o">=</span><span class="s1">&#39;mpio&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_n</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">im_file_n</span> <span class="o">=</span> <span class="n">file_n</span><span class="p">[</span><span class="n">gene</span><span class="p">][</span><span class="s1">&#39;StitchedImage&#39;</span><span class="p">]</span>
            <span class="n">transform_final_image</span><span class="p">(</span><span class="n">im_file_n</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">new_size</span><span class="p">)</span>
            <span class="n">file_n</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">apply_to_corners</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">gene</span>
                <span class="o">+</span> <span class="s1">&#39;_stitching_data&#39;</span><span class="p">)</span>
            <span class="n">transform_data_file</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span></div>
                                <span class="n">new_size</span><span class="p">)</span>


<div class="viewcode-block" id="register_final_images_reg_data_only"><a class="viewcode-back" href="../../../API/stitching/hybregistration_ref.html#pysmFISH.stitching_package.hybregistration.register_final_images_reg_data_only">[docs]</a><span class="k">def</span> <span class="nf">register_final_images_reg_data_only</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="o">=</span><span class="s1">&#39;Nuclei&#39;</span><span class="p">,</span>
                          <span class="n">sub_pic_frac</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">use_MPI</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">apply_to_corners</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">apply_warping</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                          <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Register stitched images an in all  HDF5 file in the folders. </span>
<span class="sd">    It is modified from register_final_images and saves only the reg_data</span>
<span class="sd">    file with the new coords and nothing in the hdf5 file.</span>

<span class="sd">    Loops the hybridizations in the HDF5 file, takes the stitched</span>
<span class="sd">    images as indicated by gene and then compares each image to the</span>
<span class="sd">    first image.</span>
<span class="sd">    For the comparison only a small patch of the images is used, the</span>
<span class="sd">    size of this patch can be controlled with &quot;sub_pic_frac&quot;.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    -----------</span>

<span class="sd">    folder: str</span>
<span class="sd">        The name of the folder containing the</span>
<span class="sd">        pickled file with stitching data, needs a</span>
<span class="sd">        trailing slash (&quot;/&quot;).</span>
<span class="sd">    gene: str</span>
<span class="sd">        The gene of which the stitched</span>
<span class="sd">        images are present and should be realigned.</span>
<span class="sd">        Typically this will be &#39;Nuclei&#39;, because the</span>
<span class="sd">        smFISH genes will not have enough signal to</span>
<span class="sd">        align the pictures properly.</span>
<span class="sd">        (Default: &#39;Nuclei&#39;)</span>
<span class="sd">    sub_pic_frac: float</span>
<span class="sd">        The fraction of the size of the original image that should be used to compare</span>
<span class="sd">        images. (Default: 0.2)</span>
<span class="sd">    use_MPI: bool</span>
<span class="sd">        If True open the files in MPI friendly mode, if False open files in normal</span>
<span class="sd">        single processing mode. (Default: False)</span>
<span class="sd">    apply_to_corners: bool</span>
<span class="sd">        Determines if the found</span>
<span class="sd">        registration will be applied to the tile</span>
<span class="sd">        corners in the pickled stitching data file.</span>
<span class="sd">        (Default: True)</span>
<span class="sd">    apply_warping: bool</span>
<span class="sd">        Determines if the found</span>
<span class="sd">        registration will be applied as a warp to the</span>
<span class="sd">        final pictures in the hdf5 file, should not</span>
<span class="sd">        be used with large datasets.</span>
<span class="sd">        (Default: False)</span>
<span class="sd">    region: list</span>
<span class="sd">        List of length four containing ints. The</span>
<span class="sd">        region that should be compared to determine</span>
<span class="sd">        the shift needed for registration.</span>
<span class="sd">        Should be in the order: [y_min, y_max, x_min,</span>
<span class="sd">        x_max]. When region is defined, sub_pic_frac</span>
<span class="sd">        will not be used.</span>
<span class="sd">        By default the code will determine the region</span>
<span class="sd">        itself taking a area around the</span>
<span class="sd">        center of the image with a size</span>
<span class="sd">        determined by sub_pic_frac(Default: None)</span>
<span class="sd">    compare_in_seq: bool</span>
<span class="sd">        Determines if we should compare images in sequence or if we should compare</span>
<span class="sd">        all to the first image.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">compare_in_seq</span><span class="p">:</span>
        <span class="n">file_name_list</span><span class="p">,</span> <span class="n">file_1</span><span class="p">,</span> <span class="n">im_file_1</span><span class="p">,</span> <span class="n">trans</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">,</span> \
            <span class="n">max_trans</span> <span class="o">=</span> \
            <span class="n">prepare_for_comparing</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="p">,</span>
                                  <span class="n">use_MPI</span><span class="o">=</span><span class="n">use_MPI</span><span class="p">)</span>
        <span class="c1"># Compare each file to file 1:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
            <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span><span class="p">,</span> <span class="n">file_ind</span> <span class="o">=</span> \
                <span class="n">get_single_trans</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">im_file_1</span><span class="p">,</span>
                                 <span class="n">max_trans</span><span class="p">,</span> <span class="n">sub_pic_frac</span><span class="o">=</span><span class="n">sub_pic_frac</span><span class="p">,</span>
                                 <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">use_MPI</span><span class="o">=</span><span class="n">use_MPI</span><span class="p">)</span>
            <span class="n">trans</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cur_trans</span>
            <span class="n">old_size_list</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cur_old_size</span>
        <span class="c1"># Close the hdf5 file.</span>
        <span class="n">file_1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">trans</span><span class="p">,</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">correct_trans_and_size</span><span class="p">(</span><span class="n">trans</span><span class="p">,</span>
                                                 <span class="n">old_size_list</span><span class="p">,</span>
                                                 <span class="n">max_trans</span><span class="p">,</span>
                                                 <span class="n">compare_in_seq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_name_list</span><span class="p">,</span> <span class="n">trans_relative</span><span class="p">,</span> <span class="n">old_size_list</span><span class="p">,</span> <span class="n">max_trans</span> <span class="o">=</span> \
            <span class="n">prepare_for_comparing</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span> <span class="n">compare_in_seq</span><span class="p">,</span>
                                  <span class="n">use_MPI</span><span class="o">=</span><span class="n">use_MPI</span><span class="p">)</span>
        <span class="c1"># Compare each file to previous file:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
            <span class="n">cur_trans</span><span class="p">,</span> <span class="n">max_trans</span><span class="p">,</span> <span class="n">cur_old_size</span><span class="p">,</span> <span class="n">file_ind</span> <span class="o">=</span> \
                <span class="n">get_single_relative_trans</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gene</span><span class="p">,</span>
                                          <span class="n">max_trans</span><span class="p">,</span>
                                          <span class="n">sub_pic_frac</span> <span class="o">=</span> <span class="n">sub_pic_frac</span><span class="p">,</span>
                                          <span class="n">region</span> <span class="o">=</span> <span class="n">region</span><span class="p">,</span>
                                          <span class="n">use_MPI</span> <span class="o">=</span> <span class="n">use_MPI</span><span class="p">)</span>
            <span class="n">trans_relative</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">cur_trans</span>
            <span class="n">old_size_list</span><span class="p">[</span><span class="n">file_ind</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">=</span> <span class="n">cur_old_size</span>
        <span class="n">trans</span><span class="p">,</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">correct_trans_and_size</span><span class="p">(</span><span class="n">trans_relative</span><span class="p">,</span>
                                                 <span class="n">old_size_list</span><span class="p">,</span>
                                                 <span class="n">max_trans</span><span class="p">,</span>
                                                 <span class="n">compare_in_seq</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;Files: </span><span class="si">{}</span><span class="s1"> Translations: </span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">,</span> <span class="n">trans</span><span class="p">))</span>

    <span class="c1"># Apply the translations</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">apply_to_corners</span><span class="p">:</span>
            <span class="n">data_name</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">gene</span>
            <span class="o">+</span> <span class="s1">&#39;_stitching_data&#39;</span><span class="p">)</span>
            <span class="n">transform_data_file</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">data_name</span><span class="p">,</span> <span class="n">trans</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span></div>
                                <span class="n">new_size</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, simone codeluppi.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>